{% extends "base.html" %}
{% block title %}Minecraft Server Dashboard{% endblock %}
{% block head_extra %}
<style>
html{background:#0a0a0a}
body{background:radial-gradient(1200px 500px at 50% -20%,#1b1b1f 0%,transparent 60%),radial-gradient(1200px 500px at 50% 120%,#1b1b1f 0%,transparent 60%),linear-gradient(#0a0a0a,#0a0a0a)}
p{margin:0 0 8px;line-height:1.5;color:var(--muted)}
.card{width:min(1100px,96vw);background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 22px 60px rgba(0,0,0,.45);overflow:hidden}
.header{padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.header h1{margin:0;font-size:22px;letter-spacing:.2px}
.header-right{display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#0b0b0d;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
.badge b{color:#fff}
.dot{position:relative;width:10px;height:10px;border-radius:999px;background:#444;border:1px solid #2a2a2e}
.dot.running{background:#22c55e;border-color:#1d3b29;box-shadow:0 0 0 0 rgba(34,197,94,.6);animation:dot-pulse 1.6s ease-out infinite}
.dot.running::after{content:"";position:absolute;inset:-4px;border-radius:999px;border:2px solid rgba(34,197,94,.35);animation:dot-ring 1.6s ease-out infinite}
.dot.stopped{background:#ef4444;border-color:#3a1f22;box-shadow:none;animation:none}

@keyframes dot-pulse{to{box-shadow:0 0 0 9px rgba(34,197,94,0)}}
@keyframes dot-ring{from{transform:scale(.7);opacity:.9}to{transform:scale(1.3);opacity:0}}

@media (prefers-reduced-motion: reduce){
  .dot.running,.dot.running::after{animation:none;box-shadow:none}
}
.btn{appearance:none;border:1px solid var(--border);background:#151518;color:#fff;border-radius:10px;padding:10px 14px;font-weight:500;font-size:14px;cursor:pointer;transition:transform .1s ease,background .2s ease,border-color .2s ease}
.btn:hover{background:#191a20}
.btn.primary{border-color:#3b3be0;background:linear-gradient(180deg,#5454ff,#3d3de6)}
.btn.primary:hover{filter:brightness(1.05)}
.btn.ghost{background:transparent}
.toolbar{padding:0 24px 16px;display:flex;gap:10px;flex-wrap:wrap}
.grid{padding:0 24px 24px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media (max-width:1000px){.grid{grid-template-columns:1fr}}
.panel{border:1px solid var(--border);border-radius:14px;background:#0e0e11}
.panel .title{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
.console-wrap{display:flex;flex-direction:column;height:520px}
.console-output{flex:1;padding:12px 14px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12.5px;line-height:1.45;overflow:auto;white-space:pre-wrap;word-break:break-word;background:#0b0b0d}
.console-output .warn{color:#fbbf24}
.console-output .error{color:#ef4444}
.console-output .green{color:#22c55e}
.console-output .purple{color:#a78bfa}
.console-output .yellow{color:#facc15}
.console-output .from-panel{color:#c084fc}
.console-inputbar{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
.input{flex:1;border:1px solid var(--border);background:#111114;color:#fff;border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
.side{display:flex;flex-direction:column;gap:16px}
.section{border:1px solid var(--border);border-radius:14px;background:#0e0e11}
.section .title{padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
.count-badge{margin-left:8px;font-weight:600;font-size:12px;color:#cbd5e1;background:#0b0b0d;border:1px solid var(--border);border-radius:999px;padding:2px 8px;line-height:1}
.kit{display:inline-flex;align-items:center;gap:6px;background:#0b0b0d;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:#cbd5e1}
.kit b{color:#fff}
.filebox .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
/* tiny extra space at the very top of the info list */
.filebox .row:first-child{margin-top:6px}
/* NEW: give the info area a bit of left padding */
.filebox{padding-left:14px}
/* Server Info: compact, inline-wrapping chips with minimal dead space */
.filebox{
  display:flex;
  flex-wrap:wrap;
  gap:8px 10px;
  padding:10px 14px 12px;
}
.filebox .row{display:contents; margin:0}
.kit{
  padding:6px 8px;
  font-size:12px;
  line-height:1.1;
  border-radius:8px;
}
.kit b{margin-right:6px}
/* Players list = max 3 rows, scrollable */
.players{max-height:calc(3*52px);overflow:auto}
.player{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #141418;min-height:52px}
.player:last-child{border-bottom:none}
.player .name{font-size:14px}
.more-btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);background:#151518;color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}

/* Floating dropdown (outside scroll area) */
.dropdown-portal{
  position:fixed;
  background:#0f0f10;
  border:1px solid var(--border);
  border-radius:10px;
  min-width:180px;
  box-shadow:0 14px 40px rgba(0,0,0,.45);
  display:none;
  z-index:1000;
  overflow:hidden;
}
.dropdown-portal.show{display:block}
.dropdown-portal .menu-item{
  display:block;width:100%;text-align:left;background:transparent;color:#fff;
  border:none;padding:10px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid #141418
}
.dropdown-portal .menu-item:last-child{border-bottom:none}

/* Nice scrollbars */
.console-output,.players,body{scrollbar-width:thin;scrollbar-color:#2a2a33 #0b0b0d}
.console-output{user-select:text;-webkit-user-select:text}
.console-output::-webkit-scrollbar,.players::-webkit-scrollbar{width:10px;height:10px}
.console-output::-webkit-scrollbar-track,.players::-webkit-scrollbar-track{background:#0b0b0d;border-left:1px solid #141418}
.console-output::-webkit-scrollbar-thumb,.players::-webkit-scrollbar-thumb{background:#2a2a33;border-radius:10px;border:2px solid #0b0b0d}
.console-output::-webkit-scrollbar-thumb:hover,.players::-webkit-scrollbar-thumb:hover{background:#3a3a44}

/* EULA fade control */
#accept-eula{opacity:0;pointer-events:none;transform:translateY(-4px);transition:opacity .22s ease,transform .22s ease}
#accept-eula.show{opacity:1;pointer-events:auto;transform:none}

.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:50}
.toast{min-width:280px;max-width:96vw;background:#111114;border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 14px 40px rgba(0,0,0,.45);transform:translateY(16px);opacity:0;animation:toast-in .18s ease forwards}
.toast.ok{border-color:#1f3f28}
.toast.err{border-color:#3a1f22}
.toast .t-content{flex:1}
.toast .t-title{font-weight:600;margin:0 0 2px}
.toast .t-msg{font-size:13px;color:#cbd5e1}
.toast .t-actions{display:flex;gap:8px;margin-left:8px}
.toast .t-btn{border:1px solid var(--border);background:#151518;color:#fff;border-radius:8px;padding:8px 10px;font-size:12px;cursor:pointer}
@keyframes toast-in{to{transform:translateY(0);opacity:1}}
@keyframes toast-out{to{transform:translateY(16px);opacity:0}}

.starting{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:45}
.starting .box{background:#0f0f10;border:1px solid var(--border);border-radius:14px;padding:22px;display:flex;flex-direction:column;align-items:center;gap:12px}
.loader{width:28px;height:28px;border:3px solid #2a2a33;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.btn.disabled {
  opacity: .5;
  cursor: not-allowed;
  filter: none !important;
  background:#151518 !important;
  border-color: var(--border) !important;
}
.kit.motd-chip{display:flex;align-items:center;gap:8px;flex:0 0 100%;max-width:100%}
.motd-chip b{color:#fff;flex:0 0 auto}
.motd-track{flex:1 1 0%;width:0;min-width:0;overflow:hidden;position:relative}
.motd-inner{display:inline-flex;transform:translateX(0)}
.motd-item{display:inline-block;white-space:nowrap;padding-right:40px}
.motd-dup{display:none}
.motd-chip.marquee .motd-dup{display:inline-block}
.motd-chip.marquee .motd-inner{will-change:transform;animation:motd-loop var(--motd-dur,14s) linear infinite}
@keyframes motd-loop{from{transform:translateX(0)} to{transform:translateX(-50%)}}
</style>
<style>
.sysbox{padding:12px 14px;display:flex;flex-direction:column;gap:12px}
.stat-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:1000px){.stat-row{grid-template-columns:1fr}}
.stat{border:1px solid var(--border);border-radius:10px;background:#0b0b0d;padding:10px 12px;display:flex;flex-direction:column;gap:8px}
.stat-head{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#cbd5e1}
.stat-head b{color:#fff}
.meter{height:12px;border-radius:999px;background:#111114;border:1px solid var(--border);overflow:hidden}
.meter .fill{height:100%;width:0;transition:width .25s ease;background:linear-gradient(180deg,#5454ff,#3d3de6)}
.stat-foot{font-size:12px;color:#aab1c3}
.disk-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.disk-item{border:1px solid var(--border);border-radius:10px;background:#0b0b0d;padding:10px 12px}
.disk-head{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#cbd5e1;margin-bottom:8px}
.net-row{display:flex;flex-wrap:wrap;gap:8px}
.section-metrics{grid-column:1/-1}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="header">
    <h1>Minecraft Server Dashboard</h1>
    <div class="header-right">
      <span class="badge"><b>Status</b> <span id="status-text">Unknown</span></span>
      <span id="server-dot" class="dot stopped"></span>
    </div>
  </div>

  <div class="toolbar">
    <button id="start-server" class="btn primary"><i class="material-icons" style="font-size:18px;vertical-align:-3px">play_arrow</i> Start</button>
    <button id="stop-server" class="btn"><i class="material-icons" style="font-size:18px;vertical-align:-3px">stop</i> Stop</button>
    <button id="accept-eula" class="btn ghost"><i class="material-icons" style="font-size:18px;vertical-align:-3px">rule</i> Accept EULA</button>
  </div>

  <div class="grid">
    <div class="panel console-wrap">
      <div class="title">Console</div>
      <div id="console-output" class="console-output"></div>
      <div class="console-inputbar">
        <input id="console-input" class="input" type="text" placeholder="Enter command...">
        <button id="send-command" class="btn">Send</button>
      </div>
    </div>

    <div class="side">
      <div class="section">
        <div class="title">Players <span id="players-count" class="count-badge">0</span></div>
        <div id="player-list" class="players"></div>
        <div style="padding:12px;border-top:1px solid var(--border);font-size:13px;color:#cbd5e1" id="players-empty">No active players</div>
      </div>
      <div class="section">
        <div class="title">Server Info</div>
      
        <div class="filebox">
          <span class="kit motd-chip"><b>MOTD</b><div class="motd-track"><div class="motd-inner"><span id="info-motd" class="motd-item">—</span><span class="motd-item motd-dup">—</span></div></div></span>
          <div class="row">
            <span class="kit"><b>Minecraft</b> <span id="info-version">—</span></span>
            <span class="kit"><b>Uptime</b> <span id="info-uptime">—</span></span>
            <span class="kit"><b>Java</b> <span id="info-java">—</span></span>
            <span class="kit"><b>Public IP</b> <span id="info-public">—</span></span>
            <span class="kit"><b>Local IP</b> <span id="info-local">—</span></span>
            <span class="kit"><b>Port</b> <span id="info-port">—</span></span>
            <span class="kit"><b>Online Mode</b> <span id="info-online">—</span></span>
          </div>
        </div>
      </div>
    </div>
      <div class="section section-metrics">
        <div class="title">System Metrics</div>
        <div class="sysbox">
          <div class="stat-row">
            <div class="stat">
              <div class="stat-head"><b>CPU</b> <span id="cpu-pct">—</span></div>
              <div class="meter"><div id="cpu-bar" class="fill"></div></div>
              <div class="stat-foot" id="loadavg">—</div>
            </div>
            <div class="stat">
              <div class="stat-head"><b>Memory</b> <span id="mem-pct">—</span></div>
              <div class="meter"><div id="mem-bar" class="fill"></div></div>
              <div class="stat-foot" id="mem-detail">—</div>
            </div>
            <div class="stat">
              <div class="stat-head"><b>Main Storage</b> <span id="storage-pct">—</span></div>
              <div class="meter"><div id="storage-bar" class="fill"></div></div>
              <div class="stat-foot" id="storage-detail">—</div>
            </div>
          </div>
          <div class="disk-list" id="disk-list"></div>
        </div>
      </div>
  </div>
</div>

<!-- Toasts + Floating Dropdown Portal -->
<div class="toast-wrap" id="toasts"></div>
<div id="player-dropdown" class="dropdown-portal" role="menu" aria-hidden="true"></div>

<div class="starting" id="start-modal">
  <div class="box">
    <div class="loader"></div>
    <div>Starting server…</div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded',()=> {
  function humanBytes(n){
    if(typeof n!=='number'||!isFinite(n)) return '—'
    const u=['B','KB','MB','GB','TB','PB']
    let i=0
    while(n>=1024&&i<u.length-1){n/=1024;i++}
    return n.toFixed(i?1:0)+' '+u[i]
  }

  function setBar(elPct, elBar, pct){
    const p=Math.max(0,Math.min(100,Math.round(pct||0)))
    elPct.textContent=p+'%'
    elBar.style.width=p+'%'
  }
  function renderDisks(disks){
    const wrap=document.getElementById('disk-list')
    wrap.innerHTML=''
    if(!disks||typeof disks!=='object') return
    Object.keys(disks).forEach(path=>{
      if(path==='/'||/instance/i.test(path)||/server/i.test(path)) return
      const d = disks[path] || {}
      const item = document.createElement('div')
      item.className='disk-item'

      const head=document.createElement('div')
      head.className='disk-head'
      const name=document.createElement('div')
      const pct=document.createElement('div')

      const meter=document.createElement('div')
      meter.className='meter'
      const fill=document.createElement('div')
      fill.className='fill'
      meter.appendChild(fill)

      const foot=document.createElement('div')
      foot.className='stat-foot'

      name.textContent = path
      pct.textContent=(d.percent!=null?Math.round(d.percent):'—')+(d.percent!=null?'%':'')
      fill.style.width=(d.percent!=null?Math.round(d.percent):0)+'%'
      foot.textContent=(d.used!=null&&d.total!=null)?humanBytes(d.used)+' / '+humanBytes(d.total):'—'

      head.appendChild(name)
      head.appendChild(pct)
      item.appendChild(head)
      item.appendChild(meter)
      item.appendChild(foot)
      wrap.appendChild(item)
    })
  }
  function pollSystem(){
    fetch('/system/metrics').then(r=>r.json()).then(m=>{
      const cpuPct=document.getElementById('cpu-pct')
      const cpuBar=document.getElementById('cpu-bar')
      const memPct=document.getElementById('mem-pct')
      const memBar=document.getElementById('mem-bar')
      const load=document.getElementById('loadavg')
      const memDetail=document.getElementById('mem-detail')
      setBar(cpuPct,cpuBar, m.cpu_percent)
      const la=m.loadavg||null
      if(m.loadavg&&typeof m.loadavg==='object') load.textContent=la?[la['1m'],la['5m'],la['15m']].map(x=>Number(x).toFixed(2)).join(' / '):'—'
      const mem=m.memory||{}
      const used=(typeof mem.used==='number')?mem.used:((typeof mem.total==='number'&&typeof mem.available==='number')?(mem.total-mem.available):null)
      const mpct=(typeof mem.percent==='number')?mem.percent:(mem.total? (100*used/mem.total):null)
      setBar(memPct,memBar,mpct)
      memDetail.textContent=(used!=null&&mem.total!=null)?humanBytes(used)+' / '+humanBytes(mem.total):'—'
      // Main Storage stat (root disk '/')
      const storagePctEl=document.getElementById('storage-pct')
      const storageBarEl=document.getElementById('storage-bar')
      const storageDetailEl=document.getElementById('storage-detail')
      let root = null
      if(m.disks && typeof m.disks==='object'){
        if(m.disks['/']) root = m.disks['/']
        else{
          const k = Object.keys(m.disks).find(x=>x==='/'||/^\/$/.test(x))
          root = k? m.disks[k] : null
        }
      }
      if(root){
        const dp = (root.percent!=null? Math.round(root.percent): null)
        setBar(storagePctEl, storageBarEl, dp)
        storageDetailEl.textContent = (root.used!=null&&root.total!=null)? (humanBytes(root.used)+' / '+humanBytes(root.total)) : '—'
      } else {
        setBar(storagePctEl, storageBarEl, 0)
        storageDetailEl.textContent = '—'
      }
      if(m.disks) renderDisks(m.disks)
    }).catch(()=>{})
  }
  setInterval(pollSystem,2500)
  pollSystem()
  const consoleEl=document.getElementById('console-output')
  const sendBtn=document.getElementById('send-command')
  const inputEl=document.getElementById('console-input')
  const startBtn=document.getElementById('start-server')
  const stopBtn=document.getElementById('stop-server')
  const statusText=document.getElementById('status-text')
  const dot=document.getElementById('server-dot')
  const toasts=document.getElementById('toasts')
  const playersEl=document.getElementById('player-list')
  const playersEmpty=document.getElementById('players-empty')
  const playersCount=document.getElementById('players-count')
  const eulaBtn=document.getElementById('accept-eula')
  const startModal=document.getElementById('start-modal')
  const dropdown=document.getElementById('player-dropdown')
  const exitRe=/Server process exited/i
  let awaitingExit=false
  let motdState={text:'', width:0}
  let resizeTimer=null

  const els = {
    version: document.getElementById('info-version'),
    java:    document.getElementById('info-java'),
    uptime:  document.getElementById('info-uptime'),
    public:  document.getElementById('info-public'),
    local:   document.getElementById('info-local'),
    port:    document.getElementById('info-port'),
    motd:    document.getElementById('info-motd'),
    online:  document.getElementById('info-online'),
  }

  const eulaRe=/You need to agree to the EULA/i
  const readyRe=/\[Server thread\/INFO\]: Done/i
  const errorRe=/(Exception|Error:|UnsupportedClassVersionError|Could not find or load main class|Address already in use|A fatal error has been detected|Failed|Failure)/i
  let lastStatus='init'
  let currentPlayer=null
  let currentAnchor=null

  const opsSet=new Set()
  function refreshOps(){
    fetch('/ops').then(r=>r.ok?r.json():[]).then(list=>{
      opsSet.clear()
      ;(list||[]).forEach(n=>opsSet.add(typeof n==='string'?n:(n&&n.name?n.name:'')))
    }).catch(()=>{})
  }

  function avatarSrcFor(player){
    const uuid=(typeof player==='object'&&player&&player.uuid)?player.uuid:null
    if(uuid) return 'https://mc-heads.net/avatar/'+uuid+'/24'
    const name=typeof player==='string'?player:(player&&player.name?player.name:'steve')
    return 'https://mc-heads.net/avatar/'+encodeURIComponent(name)+'/24'
  }

  function isOp(player){
    if(typeof player==='object'&&player&&typeof player.op==='boolean') return player.op
    const name=typeof player==='string'?player:(player&&player.name?player.name:'')
    return opsSet.has(name)
  }

  function truncateName(name,maxLen){
    if(!name) return ''
    if(name.length<=maxLen) return name
    return name.slice(0,Math.max(0,maxLen-1))+'…'
  }

  function setupMotdMarquee(){
    {
      const chip=document.querySelector('.motd-chip')
      if(!chip) return
      const track=chip.querySelector('.motd-track')
      const inner=chip.querySelector('.motd-inner')
      const s1=chip.querySelector('#info-motd')
      const s2=chip.querySelector('.motd-dup') || chip.querySelector('.motd-item.motd-dup')
      if(!track||!inner||!s1||!s2) return
      const text=(s1.textContent||'').trim()
      const view=Math.round(track.clientWidth)
      const sameText=(text===motdState.text)
      const widthUnchanged=(Math.abs(view - motdState.width) < 4)
      if(sameText && widthUnchanged) return
      const content=Math.round(s1.scrollWidth + 40)
      if(content > view + 8){
        const pxPerSec=35
        const dur=Math.max(12, content/pxPerSec)
        chip.style.setProperty('--motd-dur', dur+'s')
        if(s2.textContent!==text) s2.textContent=text
        chip.classList.add('marquee')
      }else{
        chip.classList.remove('marquee')
        s2.textContent=''
        inner.style.transform='translateX(0)'
      }
      motdState={text, width:view}
    }
  }

  function toast(title,msg,type,actions){
    const t=document.createElement('div')
    t.className='toast '+(type||'')
    t.innerHTML='<div class="t-content"><div class="t-title">'+title+'</div><div class="t-msg">'+(msg||'')+'</div></div>'
    const act=document.createElement('div')
    act.className='t-actions'
    ;(actions||[]).forEach(a=>{const b=document.createElement('button');b.className='t-btn';b.textContent=a.label;b.onclick=()=>{a.onClick&&a.onClick();close()};act.appendChild(b)})
    t.appendChild(act)
    toasts.appendChild(t)
    function close(){t.style.animation='toast-out .16s ease forwards';setTimeout(()=>t.remove(),160)}
    setTimeout(close,4500)
    return {close}
  }

  function colorize(line){
    if(/\[panel\]/i.test(line)) return 'from-panel'
    if(line.includes("WARN")) return 'warn'
    if(line.includes("ERROR")) return 'error'
    if(line.includes("advancement")&&line.includes("[Server thread/INFO]")&&!line.match(/ඞ.*?ඞ/)) return 'green'
    if(line.includes("completed the challenge")&&line.includes("[Server thread/INFO]")&&!line.match(/ඞ.*?ඞ/)) return 'purple'
    if(line.includes("reached the goal")&&line.includes("[Server thread/INFO]")&&!line.match(/ඞ.*?ඞ/)) return 'yellow'
    return ''
  }

  function appendLine(line){
    const div=document.createElement('div')
    div.className=colorize(line)
    div.textContent=line
    consoleEl.appendChild(div)
  }

  let autoScroll=true
  consoleEl.addEventListener('scroll',()=>{
    const nearBottom=(consoleEl.scrollTop+consoleEl.clientHeight)>=consoleEl.scrollHeight-8
    autoScroll=nearBottom
  })

  let lastCount=0
  let livePaused=false
  let pending=[]

  function selectionInsideConsole(){
    const sel=window.getSelection()
    if(!sel||sel.isCollapsed||sel.rangeCount===0) return false
    const r=sel.getRangeAt(0)
    return consoleEl.contains(r.startContainer)&&consoleEl.contains(r.endContainer)
  }

  function applyPending(){
    if(!pending.length) return
    const frag=document.createDocumentFragment()
    for(const line of pending){ const div=document.createElement('div'); div.className=colorize(line); div.textContent=line; frag.appendChild(div) }
    consoleEl.appendChild(frag)
    pending.length=0
    if(autoScroll) consoleEl.scrollTop=consoleEl.scrollHeight
  }

  document.addEventListener('selectionchange',()=>{
    const active=selectionInsideConsole()
    if(active){ livePaused=true; return }
    if(livePaused&&!active){ livePaused=false; applyPending() }
  })

  function showEula(){ eulaBtn.classList.add('show') }
  function hideEula(){ eulaBtn.classList.remove('show') }
  hideEula()

  eulaBtn.addEventListener('click', ()=>{
    fetch('/accept-eula',{method:'POST'})
      .then(r=>r.text())
      .then(()=> toast('EULA','Accepted. Restart the server to apply.','ok'))
      .catch(()=> toast('EULA','Failed to accept.','err'))
  })

  function fetchConsole(){
    fetch('/get-console-output').then(r=>r.json()).then(data=>{
      if(lastCount===0&&consoleEl.childNodes.length===0){
        const frag=document.createDocumentFragment()
        for(const line of data){ const div=document.createElement('div'); div.className=colorize(line); div.textContent=line; frag.appendChild(div) }
        consoleEl.appendChild(frag)
        lastCount=data.length
        consoleEl.scrollTop=consoleEl.scrollHeight
        return
      }
      if(data.length>lastCount){
        const inc=data.slice(lastCount)
        lastCount=data.length
        if(inc.some(l=>eulaRe.test(l))) showEula()
        if(inc.some(l=>readyRe.test(l))) hideEula()
        if(inc.some(l=>exitRe.test(l))){
          awaitingExit=false
          setButtonsForRunning(false)
          statusText.textContent='Stopped'
          dot.classList.remove('running')
          dot.classList.add('stopped')
        }
        if(livePaused){ pending.push(...inc); return }
        const frag=document.createDocumentFragment()
        for(const line of inc){ const div=document.createElement('div'); div.className=colorize(line); div.textContent=line; frag.appendChild(div) }
        consoleEl.appendChild(frag)
        if(autoScroll) consoleEl.scrollTop=consoleEl.scrollHeight
      }
    })
  }

  function sendCommand(){
    const cmd=inputEl.value.trim()
    if(!cmd) return
    fetch('/send-command',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({command:cmd})})
      .then(r=>r.json()).then(()=>{inputEl.value=''})
  }
  sendBtn.onclick=sendCommand
  inputEl.addEventListener('keydown',e=>{if(e.key==='Enter')sendCommand()})

  function setButtonsForRunning(running){
    if(running){
      startBtn.classList.add('disabled')
      startBtn.classList.remove('primary')
      startBtn.disabled=true
      stopBtn.classList.add('primary')
      stopBtn.classList.remove('disabled')
      stopBtn.disabled=false
    }else{
      stopBtn.classList.add('disabled')
      stopBtn.classList.remove('primary')
      stopBtn.disabled=true
      startBtn.classList.add('primary')
      startBtn.classList.remove('disabled')
      startBtn.disabled=false
    }
  }

  function updateStatus(){
    fetch('/server-status').then(r=>r.json()).then(s=>{
      const st=s.status
      statusText.textContent=st.charAt(0).toUpperCase()+st.slice(1)
      const running=(st==='running')
      dot.classList.toggle('running',running)
      dot.classList.toggle('stopped',!running)
      if(running){
        setButtonsForRunning(true)
        awaitingExit=false
      }else{
        if(!awaitingExit) setButtonsForRunning(false)
      }
      if(lastStatus!=='crashed'&&st==='crashed'){
        toast('Server Crashed','The server process is no longer running','err')
      }
      lastStatus=st
    })
  }

  function sendAction(act,player,extra){
    fetch('/'+act,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(Object.assign({player},extra||{}))})
      .then(r=>r.json()).then(()=>toast('Action',act+' sent','ok')).catch(()=>toast('Action','Failed','err'))
  }

  function renderPlayerRow(player){
    const rawName=typeof player==='string'?player:(player&&player.name?player.name:'')
    const shortName=truncateName(rawName,16)
    const op=isOp(player)
    const row=document.createElement('div')
    row.className='player'
    row.innerHTML='<div style="display:flex;align-items:center;gap:10px"><img class="head" alt="" width="24" height="24" style="border-radius:4px;image-rendering:pixelated"><span class="name" title="'+rawName+'">'+shortName+'</span>'+(op?'<span aria-label="OP" title="Operator" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:4px;background:#1b2a1f;border:1px solid #27422f;font-size:12px">★</span>':'')+'</div><button class="more-btn" aria-haspopup="true" aria-expanded="false"><span class="material-icons" style="font-size:18px;opacity:.8">more_vert</span></button>'
    const img=row.querySelector('img.head')
    img.src=avatarSrcFor(player)
    img.referrerPolicy='no-referrer'
    img.decoding='async'
    return row
  }

  function closeDropdown(){
    dropdown.classList.remove('show')
    dropdown.setAttribute('aria-hidden','true')
    currentPlayer=null
    currentAnchor=null
  }

  function buildDropdown(){
    dropdown.innerHTML = `
      <button class="menu-item" data-act="kick">Kick</button>
      <button class="menu-item" data-act="ban">Ban</button>
      <button class="menu-item" data-act="op">OP</button>
      <button class="menu-item" data-act="kill">Kill</button>
      <button class="menu-item" data-act="pardon">Pardon</button>
      <button class="menu-item" data-act="deop">DeOP</button>
    `
  }

  function positionDropdown(anchorBtn){
    dropdown.style.visibility='hidden'
    dropdown.classList.add('show')
    const rect = anchorBtn.getBoundingClientRect()
    const pad = 6
    const dw = dropdown.offsetWidth
    const left = Math.max(12, rect.right - dw)
    const top = rect.bottom + pad
    dropdown.style.left = left + 'px'
    dropdown.style.top = top + 'px'
    dropdown.style.visibility='visible'
  }

  playersEl.addEventListener('click', e=>{
    const btn = e.target.closest('.more-btn')
    if(btn){
      const row = btn.closest('.player')
      const name = row.querySelector('.name').textContent.replace(/…$/,'')
      if(currentPlayer === name && dropdown.classList.contains('show')){
        closeDropdown()
        return
      }
      currentPlayer = name
      currentAnchor = btn
      buildDropdown()
      positionDropdown(btn)
      dropdown.setAttribute('aria-hidden','false')
      dropdown.classList.add('show')
      return
    }
  })

  dropdown.addEventListener('click', e=>{
    const item = e.target.closest('.menu-item')
    if(!item || !currentPlayer) return
    const act = item.dataset.act
    if(act==='kick') sendAction('kick',currentPlayer,{reason:'Kicked by Admin'})
    else if(act==='ban') sendAction('ban',currentPlayer,{reason:'Banned by Admin'})
    else if(act==='op') sendAction('op',currentPlayer)
    else if(act==='kill') sendAction('kill',currentPlayer)
    else if(act==='pardon') sendAction('pardon',currentPlayer)
    else if(act==='deop') sendAction('deop',currentPlayer)
    closeDropdown()
  })

  document.addEventListener('click', e=>{
    if(dropdown.classList.contains('show')){
      const clickedInsideDropdown = e.target.closest('#player-dropdown')
      const clickedAnchor = e.target.closest('.more-btn')
      if(!clickedInsideDropdown && (!clickedAnchor || clickedAnchor!==currentAnchor)){
        closeDropdown()
      }
    }
  })

  window.addEventListener('resize', closeDropdown)
  window.addEventListener('scroll', closeDropdown, true)

  function updatePlayers(){
    fetch('/get-players').then(r=>r.json()).then(list=>{
      playersEl.innerHTML=''
      list.forEach(p=>playersEl.appendChild(renderPlayerRow(p)))
      playersEmpty.style.display=list.length? 'none':'block'
      playersCount.textContent=String(list.length)
      const names=list.map(x=>typeof x==='string'?x:(x&&x.name?x.name:'')) 
      if(currentPlayer && !names.includes(currentPlayer)) closeDropdown()
    })
  }

  function set(el, val){ el.textContent = (val ?? '—') }

  function fetchServerInfo(){
    fetch('/server-info')
      .then(r=>r.json())
      .then(info=>{
        set(els.version, info.mc_version || 'Unknown')
        set(els.java, info.java_version || 'Unknown')
        set(els.uptime, info.uptime_human || '—')
        set(els.public, info.public_ip || '—')
        set(els.local, info.local_ip || '—')
        set(els.port, info.port || '—')
        set(els.motd, info.motd || '—')
        setupMotdMarquee()
        set(els.online, info.online_mode === true ? 'true' : (info.online_mode === false ? 'false' : '—'))
      })
  }

  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer)
    resizeTimer=setTimeout(()=>setupMotdMarquee(),150)
  })

  let watcher=null
  let baselineCount=0

  function getLines(){
    const lines=[]
    consoleEl.childNodes.forEach(n=>{ if(n.nodeType===1) lines.push(n.textContent||'') })
    return lines
  }

  function startWatching(){
    stopWatching()
    baselineCount=getLines().length
    watcher=setInterval(()=>{
      const lines=getLines()
      const recent=lines.slice(baselineCount)
      if(!recent.length) return
      if(recent.some(l=>readyRe.test(l))){
        startModal.style.display='none'
        toast('Server Ready','Done loading','ok')
        stopWatching()
        return
      }
      const err=recent.slice().reverse().find(l=>errorRe.test(l))
      if(err){
        startModal.style.display='none'
        toast('Start Failed',err,'err')
        stopWatching()
      }
    },500)
  }

  function stopWatching(){
    if(watcher){ clearInterval(watcher); watcher=null }
  }

  startBtn.onclick=()=>{
    fetch('/start')
      .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.text() })
      .then(()=>{ toast('Starting','Server is starting','ok'); startModal.style.display='flex'; startWatching() })
      .catch(e=>{ startModal.style.display='none'; toast('Start Failed',String(e),'err') })
  }

  stopBtn.onclick=()=>{
    awaitingExit=true
    fetch('/stop').then(r=>r.json()).then(j=>{toast('Stopping',j.message||'Stopping server','ok')}).catch(()=>toast('Error','Failed to stop','err'))
    stopWatching()
    startModal.style.display='none'
  }

  function onSocketDrop(){}

  setInterval(fetchConsole,300)
  setInterval(updateStatus,800)
  setInterval(updatePlayers,1000)
  setInterval(fetchServerInfo,10000)
  setInterval(refreshOps,5000)

  updateStatus()
  updatePlayers()
  fetchConsole()
  fetchServerInfo()
  refreshOps()
})
</script>
{% endblock %}
