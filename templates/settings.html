{% extends "base.html" %}
{% block title %}Server Settings{% endblock %}
{% block head_extra %}
<style>
body{background:#0a0a0a}
body::before{
  content:"";
  position:fixed;
  left:0; right:0; top:0; height:420px;
  background:radial-gradient(1200px 500px at 50% -20%,#1b1b1f 0%,transparent 60%);
  pointer-events:none;
}
p{margin:0 0 8px;line-height:1.5;color:var(--muted)}
.card{width:min(1100px,96vw);background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 22px 60px rgba(0,0,0,.45);overflow:hidden}
.header{padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.header h1{margin:0;font-size:22px;letter-spacing:.2px}
.header-right{display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#0b0b0d;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
.badge b{color:#fff}
.btn{appearance:none;border:1px solid var(--border);background:#151518;color:#fff;border-radius:10px;padding:10px 14px;font-weight:500;font-size:14px;cursor:pointer;transition:transform .1s ease,background .2s ease,border-color .2s ease}
.btn:hover{background:#191a20}
.btn.primary{border-color:#3b3be0;background:linear-gradient(180deg,#5454ff,#3d3de6)}
.btn.primary:hover{filter:brightness(1.05)}
.btnbar{padding:0 24px 16px;display:flex;gap:10px;flex-wrap:wrap}

.sections{padding:0 24px 24px;display:flex;flex-direction:column;gap:16px}
.form-panel{border:1px solid var(--border);border-radius:14px;background:#0e0e11;overflow:hidden}
.form-panel .title{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;display:flex;align-items:center;justify-content:space-between}
.form-panel .subtitle{font-size:12px;color:#9aa0ab;font-weight:500}

.form-body{padding:14px 16px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:900px){.form-body{grid-template-columns:1fr}}
.field{display:flex;align-items:center;justify-content:space-between;gap:16px;border:1px solid #141418;border-radius:12px;background:#0b0b0d;padding:12px 14px;transition:border-color .18s ease,background .18s ease,transform .06s ease}
.field:focus-within{border-color:#2f2fff;background:#0f0f13}
.field:hover{border-color:#1b1b22}
.label{font-size:14px;color:#cbd5e1}
.ctrl{min-width:260px;display:flex;justify-content:flex-end;align-items:center;gap:10px}
.input,.select{width:100%;border:1px solid var(--border);background:#111114;color:#fff;border-radius:10px;padding:10px 12px;font-size:14px;outline:none;transition:border-color .18s ease,box-shadow .18s ease}
.input:focus,.select:focus{border-color:#3b3be0;box-shadow:0 0 0 3px rgba(59,59,224,.18)}
.select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8d8da8 50%),linear-gradient(135deg,#8d8da8 50%,transparent 50%),linear-gradient(to right,#111114,#111114);background-position:calc(100% - 18px) 16px,calc(100% - 12px) 16px,0 0;background-size:6px 6px,6px 6px,100% 100%;background-repeat:no-repeat}

.switch{position:relative;display:inline-flex;align-items:center;gap:10px}
.sw{position:relative;width:56px;height:32px;border-radius:999px;background:#121217;border:1px solid #22232a;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);cursor:pointer;transition:background .18s ease,border-color .18s ease}
.sw input{position:absolute;inset:0;opacity:0}
.sw i{
  position:absolute;
  left:3px;
  top:50%;
  transform:translate(0,-50%);
  width:26px;
  height:26px;
  border-radius:999px;
  background:#2b2b36;
  box-shadow:0 2px 8px rgba(0,0,0,.35),inset 0 -1px 0 rgba(255,255,255,.04);
  transition:transform .18s cubic-bezier(.22,1,.36,1),background .18s ease;
}
.sw:has(input:checked){background:linear-gradient(180deg,#5151ff,#3c3ce6);border-color:#3b3be0}
.sw:has(input:checked) i{
  transform:translate(24px,-50%);
  background:#fff;
}
.swstate{min-width:48px;height:28px;display:inline-flex;align-items:center;justify-content:center;padding:0 10px;border-radius:8px;border:1px solid #1c1d23;background:#101116;font-size:12px;color:#cbd5e1}
.switch.on .swstate{border-color:#203026;background:#0f161c;color:#9fe2ff}

.hint{font-size:12px;color:#a1a1aa;margin-top:6px}
.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:50}
.toast{min-width:280px;max-width:96vw;background:#111114;border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 14px 40px rgba(0,0,0,.45);transform:translateY(16px);opacity:0;animation:toast-in .18s ease forwards}
.toast.ok{border-color:#1f3f28}
.toast.err{border-color:#3a1f22}
.toast .t-content{flex:1}
.toast .t-title{font-weight:600;margin:0 0 2px}
.toast .t-msg{font-size:13px;color:#cbd5e1}
@keyframes toast-in{to{transform:translateY(0);opacity:1}}
@keyframes toast-out{to{transform:translateY(16px);opacity:0}}
/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: #333 #0a0a0a;
}

/* Chrome, Edge, Safari */
*::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

*::-webkit-scrollbar-track {
  background: #0a0a0a;
}

*::-webkit-scrollbar-thumb {
  background-color: #333;
  border-radius: 8px;
}

*::-webkit-scrollbar-thumb:hover {
  background-color: #444;
}
:root {
  --label-w: 180px;   /* smaller fixed width for labels */
}

.field {
  display: grid;
  grid-template-columns: var(--label-w) 1fr; /* label column + flexible input */
  align-items: center;
  gap: 10px;
}

.label {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #cbd5e1;
}

.ctrl {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 10px;
}

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
  .modal-backdrop.show{display:flex}
  .modal{width:min(980px,96vw);background:#0e0e11;border:1px solid var(--border);border-radius:16px;box-shadow:0 28px 80px rgba(0,0,0,.6);overflow:hidden}
  .modal-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .modal-title{font-weight:600}
  .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:14px 16px}
  @media(max-width:900px){.modal-body{grid-template-columns:1fr}}
  .modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
  .motd-toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  .motd-toolbar .btn{padding:6px 10px;font-size:12.5px;border-radius:8px}
  .color-grid{display:grid;grid-template-columns:repeat(8,24px);gap:6px}
  .color-swatch{width:22px;height:22px;border-radius:6px;border:1px solid #222;cursor:pointer}

  #motdEditor{width:100%;height:180px;border:1px solid var(--border);border-radius:10px;background:#111114;color:#fff;padding:10px 12px;font-size:14px;outline:none}
  #motdPreview{border:1px solid var(--border);border-radius:10px;background:#0b0b0d;padding:14px;min-height:180px;display:flex;align-items:center;justify-content:center;text-align:center}
  .mc-line{font-family:Menlo,Consolas,monospace;font-size:16px;line-height:1.4;text-shadow:0 2px 0 rgba(0,0,0,.25)}
  #motdSub{font-size:12px;color:#9aa0ab;margin-top:6px;text-align:center}
  .split-col{display:flex;flex-direction:column}
  .split-col .box{flex:1}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="header">
    <h1>Server Settings</h1>
    <div class="header-right">
      <span class="badge"><b>Profile</b> server.properties</span>
    </div>
  </div>

  <div class="btnbar">
    <button id="save" class="btn primary"><i class="material-icons" style="font-size:18px;vertical-align:-3px">save</i> Save</button>
    <button id="reload" class="btn"><i class="material-icons" style="font-size:18px;vertical-align:-3px">refresh</i> Reload</button>
  </div>

  <div class="sections">
    <div class="form-panel">
      <div class="title">General <span class="subtitle">Basics and access</span></div>
      <div class="form-body" id="group-general"></div>
    </div>

    <div class="form-panel">
      <div class="title">Network <span class="subtitle">Connectivity & visibility</span></div>
      <div class="form-body" id="group-network"></div>
    </div>

    <div class="form-panel">
      <div class="title">Gameplay <span class="subtitle">Rules & limits</span></div>
      <div class="form-body" id="group-gameplay"></div>
    </div>

    <div class="form-panel">
      <div class="title">World <span class="subtitle">Generation & performance</span></div>
      <div class="form-body" id="group-world"></div>
    </div>

    <div class="form-panel">
      <div class="title">Resource Pack <span class="subtitle">Distribution</span></div>
      <div class="form-body" id="group-rp"></div>
    </div>

    <div class="form-panel">
      <div class="title">RCON / Query <span class="subtitle">Remote control</span></div>
      <div class="form-body" id="group-remote"></div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="motdModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">MOTD Editor</div>
      <button class="btn" id="motdClose">Close</button>
    </div>
    <div class="modal-body">
      <div class="split-col">
        <div class="motd-toolbar">
          <button class="btn" data-act="bold" title="Bold (&l)"><i class="material-icons" style="font-size:16px;vertical-align:-3px">format_bold</i></button>
          <button class="btn" data-act="italic" title="Italic (&o)"><i class="material-icons" style="font-size:16px;vertical-align:-3px">format_italic</i></button>
          <button class="btn" data-act="underline" title="Underline (&n)"><i class="material-icons" style="font-size:16px;vertical-align:-3px">format_underline</i></button>
          <button class="btn" data-act="strike" title="Strikethrough (&m)"><i class="material-icons" style="font-size:16px;vertical-align:-3px">strikethrough_s</i></button>
          <button class="btn" data-act="obf" title="Obfuscated (&k)">Obf</button>
          <button class="btn" data-act="reset" title="Reset (&r)">Reset</button>
          <button class="btn" id="motdRainbow" title="Apply rainbow to selection">Rainbow</button>
        </div>
        <textarea id="motdEditor" placeholder="A Minecraft Server"></textarea>
        <div id="motdWys" contenteditable="true" style="display:none;width:100%;height:180px;border:1px solid var(--border);border-radius:10px;background:#111114;color:#fff;padding:10px 12px;font-size:14px;outline:none;overflow:auto"></div>
      </div>
      <div class="split-col">
        <div class="box" id="motdPreview"><div class="mc-line"></div></div>
        <div style="margin-top:12px">
          <div class="color-grid" id="motdColors"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="motdInsert">Use in Settings</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>
{% endblock %}

{% block scripts %}
<script>
function el(t,a,c){const n=document.createElement(t);if(a)Object.assign(n,a);if(c!==undefined)n.innerHTML=c;return n}

function mkStateBadge(checked){const s=el('span',{className:'swstate'},checked?'On':'Off');return s}
function kitSwitch(id,label,checked){
  const row=el('div',{className:'field'})
  const lab=el('div',{className:'label'},label)
  const wrap=el('div',{className:'ctrl switch'+(checked?' on':'')})
  const sw=el('label',{className:'sw'})
  const input=el('input',{type:'checkbox',id:id})
  const dot=el('i')
  const badge=mkStateBadge(!!checked)
  input.checked=!!checked
  sw.appendChild(input);sw.appendChild(dot)
  wrap.appendChild(sw);wrap.appendChild(badge)
  input.addEventListener('change',()=>{
    wrap.classList.toggle('on',input.checked)
    badge.textContent=input.checked?'On':'Off'
  })
  row.appendChild(lab);row.appendChild(wrap)
  return row
}

function kitSelect(id,label,opts,val){
  const row=el('div',{className:'field'})
  const lab=el('div',{className:'label'},label)
  const sel=el('select',{className:'select ctrl',id:id})
  opts.forEach(o=>{const op=el('option',{value:o},o);if(String(o)===String(val))op.selected=true;sel.appendChild(op)})
  row.appendChild(lab);row.appendChild(sel)
  return row
}

function kitInput(id,label,val,placeholder){
  const row=el('div',{className:'field'})
  const lab=el('div',{className:'label'},label)
  const inp=el('input',{className:'input ctrl',id:id,type:'text',value:val||'',placeholder:placeholder||''})
  row.appendChild(lab);row.appendChild(inp)
  return row
}

function kitMotd(id,label,val,placeholder){
  const row=el('div',{className:'field'})
  const lab=el('div',{className:'label'},label)
  const wrap=el('div',{className:'ctrl'})
  const inp=el('input',{className:'input',id:id,type:'text',value:val||'',placeholder:placeholder||''})
  const btn=el('button',{className:'btn',id:'motdOpen'},'<i class="material-icons" style="font-size:18px;vertical-align:-3px">edit</i> Edit')
  wrap.appendChild(inp);wrap.appendChild(btn)
  row.appendChild(lab);row.appendChild(wrap)
  btn.addEventListener('click',()=>openMotdEditor(inp))
  return row
}

function toast(t,m,type){
  const w=document.getElementById('toasts')
  const d=el('div',{className:'toast '+(type||'')})
  const c=el('div',{className:'t-content'})
  c.appendChild(el('div',{className:'t-title'},t))
  c.appendChild(el('div',{className:'t-msg'},m||''))
  d.appendChild(c);w.appendChild(d)
  setTimeout(()=>{d.style.animation='toast-out .16s ease forwards';setTimeout(()=>d.remove(),160)},4200)
}

const groups={
  general:document.getElementById('group-general'),
  network:document.getElementById('group-network'),
  gameplay:document.getElementById('group-gameplay'),
  world:document.getElementById('group-world'),
  rp:document.getElementById('group-rp'),
  remote:document.getElementById('group-remote'),
}

let current={}
let schema={}

function render(){
  groups.general.innerHTML=''
  groups.network.innerHTML=''
  groups.gameplay.innerHTML=''
  groups.world.innerHTML=''
  groups.rp.innerHTML=''
  groups.remote.innerHTML=''

  groups.general.appendChild(kitMotd('motd','MOTD',current['motd']||'','A Minecraft Server'))
  groups.general.appendChild(kitSelect('difficulty','Difficulty',schema.options.difficulty,current['difficulty']))
  groups.general.appendChild(kitSelect('gamemode','Gamemode',schema.options.gamemode,current['gamemode']))
  groups.general.appendChild(kitSwitch('online-mode','Online Mode',valTrue(current['online-mode'])))
  groups.general.appendChild(kitSwitch('hardcore','Hardcore',valTrue(current['hardcore'])))
  groups.general.appendChild(kitSwitch('enforce-whitelist','Enforce Whitelist',valTrue(current['enforce-whitelist'])))
  groups.general.appendChild(kitSwitch('pvp','PVP',valTrue(current['pvp'])))

  groups.network.appendChild(kitInput('server-ip','Server IP',current['server-ip']||'',''))
  groups.network.appendChild(kitInput('server-port','Server Port',current['server-port']||'25565','25565'))
  groups.network.appendChild(kitInput('view-distance','View Distance',current['view-distance']||'10','10'))
  groups.network.appendChild(kitInput('simulation-distance','Simulation Distance',current['simulation-distance']||'10','10'))
  groups.network.appendChild(kitInput('rate-limit','Rate Limit',current['rate-limit']||'0','0'))
  groups.network.appendChild(kitSwitch('hide-online-players','Hide Online Players',valTrue(current['hide-online-players'])))
  groups.network.appendChild(kitSwitch('log-ips','Log IPs',valTrue(current['log-ips'])))
  groups.network.appendChild(kitSwitch('use-native-transport','Use Native Transport',valTrue(current['use-native-transport'])))

  groups.gameplay.appendChild(kitSwitch('allow-flight','Allow Flight',valTrue(current['allow-flight'])))
  groups.gameplay.appendChild(kitSwitch('spawn-monsters','Spawn Monsters',valTrue(current['spawn-monsters'])))
  groups.gameplay.appendChild(kitInput('player-idle-timeout','Player Idle Timeout',current['player-idle-timeout']||'0','0'))
  groups.gameplay.appendChild(kitInput('max-players','Max Players',current['max-players']||'20','20'))
  groups.gameplay.appendChild(kitInput('spawn-protection','Spawn Protection',current['spawn-protection']||'16','16'))
  groups.gameplay.appendChild(kitSwitch('force-gamemode','Force Gamemode',valTrue(current['force-gamemode'])))
  groups.gameplay.appendChild(kitInput('function-permission-level','Function Permission Level',current['function-permission-level']||'2','2'))
  groups.gameplay.appendChild(kitInput('op-permission-level','OP Permission Level',current['op-permission-level']||'4','4'))

  groups.world.appendChild(kitInput('level-name','Level Name',current['level-name']||'world','world'))
  groups.world.appendChild(kitInput('level-seed','Level Seed',current['level-seed']||'',''))
  groups.world.appendChild(kitSelect('level-type','Level Type',schema.options['level-type'],current['level-type']))
  groups.world.appendChild(kitSwitch('generate-structures','Generate Structures',valTrue(current['generate-structures'])))
  groups.world.appendChild(kitInput('max-world-size','Max World Size',current['max-world-size']||'29999984','29999984'))
  groups.world.appendChild(kitInput('max-tick-time','Max Tick Time',current['max-tick-time']||'60000','60000'))
  groups.world.appendChild(kitInput('entity-broadcast-range-percentage','Entity Broadcast %',current['entity-broadcast-range-percentage']||'100','100'))
  groups.world.appendChild(kitInput('simulation-distance','Simulation Distance',current['simulation-distance']||'10','10'))

  groups.rp.appendChild(kitSwitch('require-resource-pack','Require Resource Pack',valTrue(current['require-resource-pack'])))
  groups.rp.appendChild(kitInput('resource-pack','Resource Pack URL',current['resource-pack']||'',''))
  groups.rp.appendChild(kitInput('resource-pack-prompt','Resource Pack Prompt',current['resource-pack-prompt']||'',''))
  groups.rp.appendChild(kitInput('resource-pack-sha1','Resource Pack SHA1',current['resource-pack-sha1']||'',''))

  groups.remote.appendChild(kitSwitch('enable-rcon','Enable RCON',valTrue(current['enable-rcon'])))
  groups.remote.appendChild(kitInput('rcon.port','RCON Port',current['rcon.port']||'25575','25575'))
  groups.remote.appendChild(kitInput('rcon.password','RCON Password',current['rcon.password']||'',''))
  groups.remote.appendChild(kitSwitch('enable-query','Enable Query',valTrue(current['enable-query'])))
  groups.remote.appendChild(kitInput('query.port','Query Port',current['query.port']||'25565','25565'))
}

function valTrue(v){if(typeof v==='boolean')return v;return String(v).toLowerCase()==='true'}

function collect(){
  const get=(id)=>document.getElementById(id)
  const data={}
  ;['motd','difficulty','gamemode','server-ip','server-port','view-distance','simulation-distance','rate-limit','player-idle-timeout','max-players','spawn-protection','function-permission-level','op-permission-level','level-name','level-seed','level-type','max-world-size','max-tick-time','entity-broadcast-range-percentage','resource-pack','resource-pack-prompt','resource-pack-sha1','rcon.port','rcon.password','query.port'].forEach(k=>{
    const el=get(k);if(!el)return;data[k]=el.value
  })
  ;['online-mode','hardcore','enforce-whitelist','pvp','hide-online-players','log-ips','use-native-transport','allow-flight','spawn-monsters','force-gamemode','generate-structures','require-resource-pack','enable-rcon','enable-query'].forEach(k=>{
    const el=get(k);if(!el)return;data[k]=el.checked
  })
  return data
}

function load(){
  fetch('/settings-data').then(r=>r.json()).then(j=>{current=j.values;schema=j.schema;render()})
}

document.getElementById('save').addEventListener('click',()=>{
  const payload=collect()
  fetch('/settings-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
  .then(r=>r.json()).then(j=>{if(j.ok){toast('Saved','server.properties updated','ok')}else{toast('Error',j.error||'Save failed','err')}})
})

document.getElementById('reload').addEventListener('click',load)
document.addEventListener('DOMContentLoaded',load)

// MOTD Editor logic
const mcColors={
  '0':'#000000','1':'#0000AA','2':'#00AA00','3':'#00AAAA','4':'#AA0000','5':'#AA00AA','6':'#FFAA00','7':'#AAAAAA','8':'#555555','9':'#5555FF','a':'#55FF55','b':'#55FFFF','c':'#FF5555','d':'#FF55FF','e':'#FFFF55','f':'#FFFFFF'
}

function decodeSectionEscapes(s){
  if(!s) return ''
  return s.replace(/\\u00A7/gi,'§')
}
function toUiMotd(s){
  if(!s) return ''
  s = decodeSectionEscapes(s)
  s = s.replace(/§/g,'&')
  return s
}
function toPropertiesMotd(s){
  if(!s) return ''
  let out = String(s)
  out = out.replace(/§/g,'&')
  out = out.replace(/&([0-9a-fk-or])/gi,'\\u00A7$1')
  out = out.replace(/\r?\n/g,'\\n')
  return out
}

function buildColorGrid(){
  const grid=document.getElementById('motdColors')
  grid.innerHTML=''
  Object.entries(mcColors).forEach(([k,v])=>{
    const sw=document.createElement('div')
    sw.className='color-swatch'
    sw.style.background=v
    sw.dataset.code='&'+k
    sw.addEventListener('click',()=>applyCodeToSelection('&'+k))
    grid.appendChild(sw)
  })
}

function selectionWrap(textarea,prefix,suffix){
  const s=textarea.selectionStart
  const e=textarea.selectionEnd
  const v=textarea.value
  const before=v.slice(0,s)
  const sel=v.slice(s,e)
  const after=v.slice(e)
  if(s===e){
    textarea.value=before+prefix+after
    const pos=(before+prefix).length
    textarea.selectionStart=textarea.selectionEnd=pos
  }else{
    const suff=suffix||''
    textarea.value=before+prefix+sel+suff+after
    const start=(before+prefix).length
    textarea.selectionStart=start
    textarea.selectionEnd=start+sel.length
  }
  textarea.focus()
  updateMotdPreview()
}

function useWys(){return false}
function wysFocus(){document.getElementById('motdWys').focus()}
function applyExec(cmd,val){document.execCommand(cmd,false,val)}
function applyCodeToSelection(code){
  if(useWys()){
    const map={
      '&0':'#000000','&1':'#0000AA','&2':'#00AA00','&3':'#00AAAA','&4':'#AA0000','&5':'#AA00AA','&6':'#FFAA00','&7':'#AAAAAA','&8':'#555555','&9':'#5555FF','&a':'#55FF55','&b':'#55FFFF','&c':'#FF5555','&d':'#FF55FF','&e':'#FFFF55','&f':'#FFFFFF'
    }
    if(map[code]){wysFocus();applyExec('foreColor',map[code]);return}
    if(code==='&l'){wysFocus();applyExec('bold');return}
    if(code==='&o'){wysFocus();applyExec('italic');return}
    if(code==='&n'){wysFocus();applyExec('underline');return}
    if(code==='&m'){wysFocus();applyExec('strikeThrough');return}
    if(code==='&k'){return}
    if(code==='&r'){document.getElementById('motdWys').innerHTML=document.getElementById('motdWys').innerHTML;return}
  } else {
    const needsReset=/^&[0-9a-fk-or]$/i.test(code)
    const suffix=needsReset?'&r':''
    selectionWrap(document.getElementById('motdEditor'),code,suffix)
  }
}
function nearestMc(hex){const mc={'0':'#000000','1':'#0000AA','2':'#00AA00','3':'#00AAAA','4':'#AA0000','5':'#AA00AA','6':'#FFAA00','7':'#AAAAAA','8':'#555555','9':'#5555FF','a':'#55FF55','b':'#55FFFF','c':'#FF5555','d':'#FF55FF','e':'#FFFF55','f':'#FFFFFF'};function p(h){h=h.replace('#','');if(h.length===3)h=h.split('').map(x=>x+x).join('');const n=parseInt(h,16);return[(n>>16)&255,(n>>8)&255,n&255]}const t=p(hex);let best='f',d=1e9;for(const [k,v] of Object.entries(mc)){const c=p(v);const dd=(c[0]-t[0])**2+(c[1]-t[1])**2+(c[2]-t[2])**2;if(dd<d){d=dd;best=k}}return '&'+best}
function exportWysToMotd(){
  const root=document.getElementById('motdWys')
  let out='',last={color:'',b:false,i:false,u:false,s:false}
  function walk(n,st){if(n.nodeType===3){const text=n.nodeValue||'';if(text){if(st.color!==last.color||st.b!==last.b||st.i!==last.i||st.u!==last.u||st.s!==last.s){out+='&r';if(st.color)out+=nearestMc(st.color);if(st.b)out+='&l';if(st.i)out+='&o';if(st.u)out+='&n';if(st.s)out+='&m';last={...st}}out+=text}return}
    if(n.nodeType!==1)return;const tag=n.tagName;const style=n.getAttribute('style')||'';const st2={...st};if(tag==='B'||tag==='STRONG')st2.b=true; if(tag==='I'||tag==='EM')st2.i=true; if(tag==='U')st2.u=true; if(tag==='S'||tag==='STRIKE'||tag==='DEL')st2.s=true; const m=/color:\s*([^;]+);/i.exec(style); if(m){let v=m[1].trim();if(v.startsWith('rgb')){const a=v.match(/\d+/g)||[255,255,255];v="#"+((1<<24)+(parseInt(a[0])<<16)+(parseInt(a[1])<<8)+parseInt(a[2])).toString(16).slice(1).toUpperCase()} st2.color=v}
    for(let i=0;i<n.childNodes.length;i++)walk(n.childNodes[i],st2)
  }
  walk(root,{color:'',b:false,i:false,u:false,s:false});
  if(out.startsWith('&r')) out=out.slice(2);
  return out
}
function translateMotdToHtml(s){
  if(!s)return ''
  s = decodeSectionEscapes(s)
  s = s.replace(/\\n/g,'\n')
  s=s.replace(/§/g,'&')
  let i=0
  let cur={color:'#FFFFFF',b:false,i:false,u:false,s:false,k:false}
  let buf=''
  const out=[]
  const flush=()=>{
    if(!buf) return
    let style='color:'+cur.color+';'
    if(cur.b) style+='font-weight:700;'
    if(cur.i) style+='font-style:italic;'
    if(cur.u||cur.s){
      let dec=[]; if(cur.u) dec.push('underline'); if(cur.s) dec.push('line-through');
      style+='text-decoration:'+dec.join(' ')+';text-decoration-thickness: from-font;'
    }
    out.push('<span style="'+style+'">'+buf.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</span>')
    buf=''
  }
  while(i<s.length){
    const ch=s[i]
    if((ch==='&' || ch==='§') && i+1<s.length){
      const code=s[i+1].toLowerCase()
      if(mcColors[code]||'klmnor'.includes(code)){
        flush()
        if(mcColors[code]){cur.color=mcColors[code]}
        else if(code==='l'){cur.b=true}
        else if(code==='o'){cur.i=true}
        else if(code==='n'){cur.u=true}
        else if(code==='m'){cur.s=true}
        else if(code==='k'){cur.k=true}
        else if(code==='r'){cur={color:'#FFFFFF',b:false,i:false,u:false,s:false,k:false}}
        i+=2;continue
      }
    }
    buf+=s[i]
    i++
  }
  flush()
  for(let i=0;i<out.length;i++){
    out[i]=out[i].replace(/\n/g,'<br>')
  }
  return out.join('')
}

function updateMotdPreview(){
  const p=document.querySelector('#motdPreview .mc-line')
  const t=toUiMotd(document.getElementById('motdEditor').value)
  p.innerHTML=translateMotdToHtml(t)
}

function openMotdEditor(bindTo){
  const m=document.getElementById('motdModal')
  const ed=document.getElementById('motdEditor')
  ed.value=toUiMotd(bindTo.value||'')
  m.dataset.bind=bindTo.id
  const wys=document.getElementById('motdWys')
  wys.innerHTML=translateMotdToHtml(ed.value)
  wys.style.display='none'
  ed.style.display='block'
  buildColorGrid()
  updateMotdPreview()
  m.classList.add('show')
}

function closeMotdEditor(){
  document.getElementById('motdModal').classList.remove('show')
}

document.addEventListener('input',e=>{
  if(!e.target) return
  if(e.target.id==='motdEditor') updateMotdPreview()
})

document.getElementById('motdClose').addEventListener('click',closeMotdEditor)

document.getElementById('motdInsert').addEventListener('click',()=>{
  const bind=document.getElementById(document.getElementById('motdModal').dataset.bind)
  let val
  if(useWys()){val=exportWysToMotd()}else{val=document.getElementById('motdEditor').value}
  if(bind){bind.value=toPropertiesMotd(val)}
  closeMotdEditor()
})

function applyRainbow(){
  if(useWys()){
    const sel=window.getSelection();if(!sel||sel.isCollapsed)return;const range=sel.getRangeAt(0);const text=range.toString();if(!text)return;const palette=['#FF5555','#FFAA00','#FFFF55','#55FF55','#55FFFF','#5555FF','#FF55FF'];let i=0;const frag=document.createDocumentFragment();for(const ch of text){const span=document.createElement('span');span.style.color=palette[i%palette.length];span.textContent=ch;i++;frag.appendChild(span)};range.deleteContents();range.insertNode(frag);sel.removeAllRanges();return}
  const ed=document.getElementById('motdEditor');let s=ed.selectionStart;let e=ed.selectionEnd;const v=ed.value;if(s===e) return;const seg=v.slice(s,e);const palette=['&c','&6','&e','&a','&b','&9','&d'];let out='';for(let i=0;i<seg.length;i++){out+=palette[i%palette.length]+seg[i]}ed.value=v.slice(0,s)+out+v.slice(e);ed.selectionStart=s;ed.selectionEnd=s+out.length;updateMotdPreview()
}

function hexToRgb(h){h=h.replace('#','');if(h.length===3)h=h.split('').map(x=>x+x).join('');const n=parseInt(h,16);return[(n>>16)&255,(n>>8)&255,n&255]}
function lerp(a,b,t){return a+(b-a)*t}
function rgbToMc([r,g,b]){
  const entries=Object.entries(mcColors).map(([k,v])=>[k,parseInt(v.slice(1),16)])
  let best='f',bestd=1e9
  for(const [k,n] of entries){const R=(n>>16)&255,G=(n>>8)&255,B=n&255;const d=(R-r)*(R-r)+(G-g)*(G-g)+(B-b)*(B-b);if(d<bestd){bestd=d;best=k}}
  return '&'+best
}
function applyGradient(){
  const ed=document.getElementById('motdEditor')
  let s=ed.selectionStart
  let e=ed.selectionEnd
  const v=ed.value
  if(s===e) return
  const seg=v.slice(s,e)
  const a=hexToRgb(document.getElementById('gradStart').value||'#ff5555')
  const b=hexToRgb(document.getElementById('gradEnd').value||'#55ffff')
  let out=''
  const len=Math.max(1,seg.length)
  for(let i=0;i<seg.length;i++){
    const t=len===1?0:i/(len-1)
    const col=[Math.round(lerp(a[0],b[0],t)),Math.round(lerp(a[1],b[1],t)),Math.round(lerp(a[2],b[2],t))]
    out+=rgbToMc(col)+seg[i]
  }
  ed.value=v.slice(0,s)+out+v.slice(e)
  ed.selectionStart=s
  ed.selectionEnd=s+out.length
  updateMotdPreview()
}

document.getElementById('motdRainbow').addEventListener('click',applyRainbow)

document.querySelectorAll('.motd-toolbar .btn').forEach(b=>{
  const act=b.dataset.act
  if(!act)return
  b.addEventListener('click',()=>{
    if(act==='bold')applyCodeToSelection('&l')
    else if(act==='italic')applyCodeToSelection('&o')
    else if(act==='underline')applyCodeToSelection('&n')
    else if(act==='strike')applyCodeToSelection('&m')
    else if(act==='obf')applyCodeToSelection('&k')
    else if(act==='reset')applyCodeToSelection('&r')
  })
})


document.getElementById('motdModal').addEventListener('click',e=>{if(e.target.id==='motdModal')closeMotdEditor()})
</script>
{% endblock %}
