{% extends "base.html" %}
{% block title %}Panel Settings{% endblock %}
{% block head_extra %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body{background:#0a0a0a}
body::before{content:"";position:fixed;left:0;right:0;top:0;height:420px;background:radial-gradient(1200px 500px at 50% -20%,#1b1b1f 0%,transparent 60%);pointer-events:none}
.card{width:min(1100px,96vw);background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 22px 60px rgba(0,0,0,.45);overflow:hidden}
.header{padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.header h1{margin:0;font-size:22px;letter-spacing:.2px}
.header-right{display:flex;align-items:center;gap:10px}
.badge{display:inline-flex;align-items:center;gap:6px;background:#0b0b0d;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
.badge b{color:#fff}
.btn{appearance:none;border:1px solid var(--border);background:#151518;color:#fff;border-radius:10px;padding:10px 14px;font-weight:500;font-size:14px;cursor:pointer;transition:transform .1s ease,background .2s ease,border-color .2s ease}
.btn:hover{background:#191a20}
.btn.primary{border-color:#3b3be0;background:linear-gradient(180deg,#5454ff,#3d3de6)}
.btn.primary:hover{filter:brightness(1.05)}
.layout{padding:0 24px 24px;display:grid;grid-template-columns:340px 1fr;gap:16px}
@media (max-width:1000px){.layout{grid-template-columns:1fr}}
.panel{border:1px solid var(--border);border-radius:14px;background:#0e0e11;display:flex;flex-direction:column;min-height:auto;height:auto;overflow:hidden}
.panel .title{padding:12px 14px;border-bottom:0;font-weight:600;display:flex;align-items:center;justify-content:space-between;gap:10px}
.section{padding:10px 12px;border:0;background:transparent}
.section + .section{border-top:1px solid var(--border)}
.title + .section{border-top:0}
.panel .section{border-radius:0}
.panel .section:first-of-type{border-top-left-radius:14px;border-top-right-radius:14px}
.panel .section:last-of-type{border-bottom-left-radius:14px;border-bottom-right-radius:14px}
.panel .section:not(:first-of-type):not(:last-of-type){border-radius:0}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.grid2{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:220px 1fr;align-items:center;gap:10px;margin-bottom:8px}
.row:last-child{margin-bottom:0}
.row .label{color:#cbd5e1;font-size:14px}
.input{border:1px solid var(--border);background:#111114;color:#fff;border-radius:10px;padding:10px 12px;font-size:14px;outline:none;width:100%}
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
input[type=number]{ -moz-appearance:textfield; appearance:textfield }
.num{position:relative;display:flex;align-items:center}
.num .input{padding-right:34px}
.stepper-btns{position:absolute;right:6px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:3px}
.stepper-btns button{width:16px;height:14px;padding:0;border:1px solid var(--border);background:#151518;color:#cbd5e1;border-radius:5px;display:grid;place-items:center;cursor:pointer;font-size:12px;line-height:1;transition:background .15s,border-color .15s}
.stepper-btns .mi{font-size:12px;line-height:1}
.small{font-size:12px;color:#9aa0ab}
.toolbar{padding:10px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:auto}
.kv{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:13px;padding:10px 12px}
.kv .k{color:#9aa0ab}
.stat{display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid var(--border)}
.stat:last-child{border-bottom:none}
.dot{width:10px;height:10px;border-radius:999px;background:#444;border:1px solid #2a2ae2}
.dot.ok{background:#22c55e;border-color:#1d3b29}
.dot.bad{background:#ef4444;border-color:#3a1f22}
.dot.blink{animation:dot-blink 1.2s ease-in-out infinite}
.dot.dynamic{position:relative;background:var(--dot-color,#22c55e);border-color:var(--dot-color,#22c55e)}
.dot.breathe{animation:dot-breathe 2s ease-in-out infinite}
@keyframes dot-breathe{0%,100%{transform:scale(1);opacity:.95}50%{transform:scale(1.12);opacity:.6}}
.dot.ping::after{content:"";position:absolute;inset:-3px;border-radius:999px;border:2px solid var(--dot-color,#22c55e);opacity:.55;animation:dot-ping 2.2s ease-out infinite}
@keyframes dot-ping{0%{transform:scale(.7);opacity:.55}80%{transform:scale(1.6);opacity:0}100%{transform:scale(1.6);opacity:0}}
@keyframes dot-blink{0%,60%{opacity:.55}100%{opacity:1}}
.tag{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-size:12px;justify-content:center}
.tag.info{background:#121217;border:1px solid #2a2a33;color:#cbd5e1;display:block;margin:12px auto 0;max-width:calc(100% - 24px);text-align:center}
.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:50}
.toast{min-width:280px;max-width:96vw;background:#111114;border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 14px 40px rgba(0,0,0,.45);transform:translateY(16px);opacity:0;animation:toast-in .18s ease forwards}
.toast.ok{border-color:#1f3f28}
.toast.err{border-color:#3a1f22}
.toast .t-content{flex:1}
.toast .t-title{font-weight:600;margin:0 0 2px}
.toast .t-msg{font-size:13px;color:#cbd5e1}
@keyframes toast-in{to{transform:translateY(0);opacity:1}}
@keyframes toast-out{to{transform:translateY(16px);opacity:0}}
.switch{position:relative;display:inline-block;width:44px;height:24px;vertical-align:middle}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#2a2a33;border:1px solid #1f1f25;transition:.2s;border-radius:30px}
.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;top:50%;transform:translateY(-50%);background:#fff;border-radius:50%;transition:.2s}
.switch input:checked + .slider{background:#3b3be0;border-color:#2f2fb5}
.switch input:checked + .slider:before{transform:translate(20px,-50%)}
.help{margin-left:8px}
.table{display:block;width:100%;padding:8px;border:0;background:transparent;max-height:unset;overflow:visible;scrollbar-width:thin;scrollbar-color:#2a2d37 transparent}
.table::-webkit-scrollbar{width:8px;height:8px}
.table::-webkit-scrollbar-track{background:transparent}
.table::-webkit-scrollbar-thumb{background:#2a2d37;border-radius:10px}
.table::-webkit-scrollbar-thumb:hover{background:#343949}

.tr{display:grid;grid-template-columns:1fr 100px 160px;gap:14px;align-items:center;background:#0f0f12;border:1px solid #141418;border-top-color:transparent;border-radius:10px;padding:10px 12px;min-height:56px}
.tr:hover{background:#111116;border-color:#1a1b22;border-top-color:transparent}
.th{opacity:.8;font-size:12px;background:transparent;border:0;margin:0 0 6px}

.modal{position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,.55);display:none;z-index:2147483647 !important;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal .box{width:min(560px,95vw);background:#0f0f12;border:1px solid #141418;border-radius:14px;box-shadow:0 22px 60px rgba(0,0,0,.5);overflow:hidden}
.modal .box .hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:600}
.modal .box .bd{padding:12px 14px}
.checklist{display:flex;flex-direction:column;gap:10px;margin:8px 0}
.step{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #141418;border-radius:10px;background:#0e0e11}
.step .mi{font-size:18px}
.step .t{flex:1}
.step.pending{opacity:.7}
.step.active{border-color:#2f2fb5}
.step.done{border-color:#1f3f28}
.step.err{border-color:#3a1f22}
.modal .ft{display:flex;justify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--border)}
.modal.show .box{animation:pop .18s ease}
@keyframes pop{0%{transform:scale(.98);opacity:.0}100%{transform:scale(1);opacity:1}}
.step{position:relative}
.step .dot-mini{width:10px;height:10px;border-radius:50%;border:1px solid #2a2a33;background:#2a2a33}
.step .dot-mini.ok{background:#22c55e;border-color:#1f3f28}
.step .dot-mini.err{background:#ef4444;border-color:#3a1f22}
.step.active .dot-mini{background:#3b3be0;border-color:#2f2fb5}
.step .spin-sm{display:none;width:14px;height:14px;border:2px solid #cbd5e1;border-right-color:transparent;border-radius:50%;animation:spin .6s linear infinite}
.step.active .spin-sm{display:inline-block}
.step.active{box-shadow:0 0 0 2px rgba(63,63,230,.18) inset}

#backup-rows{
  --row-h:56px;
  --row-gap:8px;
  display:flex;
  flex-direction:column;
  gap:var(--row-gap);
  padding:6px 2px 0;
  max-height:calc(3 * var(--row-h) + 2 * var(--row-gap));
  overflow:auto;
  scrollbar-width:thin;
  scrollbar-color:#2a2d37 transparent
}
#backup-rows::-webkit-scrollbar{width:8px;height:8px}
#backup-rows::-webkit-scrollbar-track{background:transparent}
#backup-rows::-webkit-scrollbar-thumb{background:#2a2d37;border-radius:10px}
#backup-rows::-webkit-scrollbar-thumb:hover{background:#343949}
.actions{display:flex;gap:8px;justify-content:flex-end}
.name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:8px}
.name .mi{font-size:18px;opacity:.9}
.btn.sm{padding:8px 10px;font-size:12px;border-radius:8px}
.btn.icon{display:inline-flex;align-items:center;gap:6px}
.btn.warn{border-color:#3a1f22}
.btn.danger{border-color:#3a1f22;background:#1a0f10}
.btn.danger:hover{filter:brightness(1.05)}
.btn.success{border-color:#1f3f28}
.btn.flat{background:#151518}
.btn.icon .mi{margin-right:0}
.section.backups{padding-top:28px}
.section.backups .table{margin-top:18px}
.btn.loading{opacity:.8;pointer-events:none;position:relative}
.btn .spin{display:none;width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;animation:spin .6s linear infinite;vertical-align:-3px;margin-right:8px}
.btn.loading .spin{display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.btn .mi{font-size:18px;vertical-align:-3px;margin-right:8px}
.span-2{grid-column:1/-1}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="header">
    <h1>Panel Settings</h1>
    <div class="header-right">
      <span class="badge"><b>Status</b> <span id="status-text">Unknown</span></span>
    </div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="title">Server Status</div>
      <div class="stat"><span id="dot-running" class="dot"></span><div><div class="small">Process</div><div id="proc-txt">Unknown</div></div></div>
      <div class="stat"><span id="dot-port" class="dot"></span><div><div class="small">Port</div><div id="port-txt">Unknown</div></div></div>
      <div class="stat"><span class="dot dynamic" id="dot-uptime"></span><div><div class="small">Uptime</div><div id="uptime-txt">—</div></div></div>
      <div class="section backups">
        <div class="kv">
          <div class="k">Minecraft</div><div id="mc-ver">—</div>
          <div class="k">Java</div><div id="java-ver">—</div>
          <div class="k">Public IP</div><div id="pub-ip">—</div>
          <div class="k">Local IP</div><div id="loc-ip">—</div>
          <div class="k">MOTD</div><div id="motd">—</div>
        </div>
      </div>
      <span class="tag info">Changes to RAM/JVM apply on next server start!</span>
      <div class="toolbar">
        <button id="btn-start" class="btn"><span class="material-icons mi">play_arrow</span><span>Start</span></button>
        <button id="btn-stop" class="btn"><span class="material-icons mi">stop</span><span>Stop</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="title">Configuration</div>

      <div class="section">
        <div class="row">
          <div class="label">Auto restart on crash</div>
          <div>
            <label class="switch"><input id="auto_restart" type="checkbox"><span class="slider"></span></label>
            <span class="small help">Restarts when process dies</span>
          </div>
        </div>
        <div class="row">
          <div class="label">Restart delay (s)</div>
          <div>
            <div class="num">
              <input id="restart_delay_sec" class="input stepper" type="number" min="0" step="1">
              <div class="stepper-btns" data-for="restart_delay_sec">
                <button type="button" data-dir="up"><span class="material-icons mi">expand_less</span></button>
                <button type="button" data-dir="down"><span class="material-icons mi">expand_more</span></button>
              </div>
            </div>
            <div class="small" style="margin-top:6px">Seconds to wait before auto‑restart after a crash</div>
          </div>
        </div>
        <div class="row">
          <div class="label">Auto start on boot</div>
          <label class="switch"><input id="auto_start_on_boot" type="checkbox"><span class="slider"></span></label>
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="label">Min RAM (MB)</div>
          <div class="num">
            <input id="min_ram_mb" class="input stepper" type="number" min="256" step="128">
            <div class="stepper-btns" data-for="min_ram_mb">
              <button type="button" data-dir="up"><span class="material-icons mi">expand_less</span></button>
              <button type="button" data-dir="down"><span class="material-icons mi">expand_more</span></button>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="label">Max RAM (MB)</div>
          <div class="num">
            <input id="max_ram_mb" class="input stepper" type="number" min="256" step="128">
            <div class="stepper-btns" data-for="max_ram_mb">
              <button type="button" data-dir="up"><span class="material-icons mi">expand_less</span></button>
              <button type="button" data-dir="down"><span class="material-icons mi">expand_more</span></button>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="label">JVM extra flags</div>
          <input id="jvm_extra" class="input" placeholder="-XX:+UseG1GC -XX:MaxGCPauseMillis=100">
        </div>
      </div>

      <div class="section">
        <div class="row">
          <div class="label">Scheduled restart</div>
          <div>
            <label class="switch"><input id="scheduled_restart_enabled" type="checkbox"><span class="slider"></span></label>
          </div>
        </div>
        <div class="grid2">
          <div class="row">
            <div class="label">Time (HH:MM)</div>
            <input id="scheduled_restart_time" class="input" type="time" step="60">
          </div>
          <div class="row">
            <div class="label">Backup before restart</div>
            <label class="switch"><input id="backup_on_restart" type="checkbox"><span class="slider"></span></label>
          </div>
        </div>
        <div class="row">
          <div class="label">Backups to keep</div>
          <div class="num">
            <input id="backup_keep" class="input stepper" type="number" min="1" step="1">
            <div class="stepper-btns" data-for="backup_keep">
              <button type="button" data-dir="up"><span class="material-icons mi">expand_less</span></button>
              <button type="button" data-dir="down"><span class="material-icons mi">expand_more</span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button id="btn-save" class="btn primary">Save</button>
        <button id="btn-restart" class="btn"><span class="material-icons mi">restart_alt</span><span>Restart Server</span></button>
      </div>
    </div>

    <div class="panel span-2" style="min-height:auto;height:auto">
        <div class="title">Backups
        <div class="actions">
          <button id="btn-backup-refresh" class="btn">Refresh</button>
          <button id="btn-backup-create" class="btn"><span class="spin"></span><span class="txt">Create Backup</span></button>
        </div>
      </div>
      <div class="section" style="border-bottom:0; padding:6px 8px">
        <div class="table" style="padding-top:0;padding-bottom:0">
          <div class="tr th" style="background:transparent;border:0;padding:0;margin:0">
            <div class="small-title">Name</div>
            <div class="small-title">Size</div>
            <div style="text-align:right" class="small-title">Actions</div>
          </div>
          <div id="backup-rows"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<div id="confirm-modal" class="modal">
  <div class="box">
    <div class="hd">Confirm Restore</div>
    <div class="bd"><div id="confirm-msg">Are you sure?</div></div>
    <div class="ft">
      <button id="confirm-cancel" class="btn">Cancel</button>
      <button id="confirm-yes" class="btn primary">Yes, restore</button>
    </div>
  </div>
</div>

<div id="restore-modal" class="modal">
  <div class="box">
    <div class="hd">Restoring Backup<div id="restore-sub" class="small">Working…</div></div>
    <div class="bd">
      <div class="checklist">
        <div class="step pending" data-step="locking"><span class="dot-mini"></span><span class="material-icons mi">lock</span><div class="t">Locking panel</div><span class="spin-sm"></span></div>
        <div class="step pending" data-step="stopping"><span class="dot-mini"></span><span class="material-icons mi">stop_circle</span><div class="t">Stopping server</div><span class="spin-sm"></span></div>
        <div class="step pending" data-step="replacing"><span class="dot-mini"></span><span class="material-icons mi">folder_zip</span><div class="t">Replacing files</div><span class="spin-sm"></span></div>
        <div class="step pending" data-step="unlocking"><span class="dot-mini"></span><span class="material-icons mi">lock_open</span><div class="t">Unlocking</div><span class="spin-sm"></span></div>
        <div class="step pending" data-step="done"><span class="dot-mini"></span><span class="material-icons mi">check_circle</span><div class="t">Finished</div><span class="spin-sm"></span></div>
      </div>
    </div>
    <div class="ft">
      <button id="restore-close" class="btn">Close</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function motdToHtml(raw){
  if(!raw) return ''
  let s=String(raw)
  const hexRe=/&#([0-9a-fA-F]{6})/g
  s=s.replace(/§x(§[0-9a-fA-F]){6}/g, m=>{
    const hex=m.replace(/§x/g,'').replace(/§/g,'').toLowerCase()
    return `§#${hex}`
  })
  s=s.replace(hexRe,'§#$1')
  const map={
    '0':'#000000','1':'#0000aa','2':'#00aa00','3':'#00aaaa','4':'#aa0000','5':'#aa00aa','6':'#ffaa00','7':'#aaaaaa','8':'#555555','9':'#5555ff','a':'#55ff55','b':'#55ffff','c':'#ff5555','d':'#ff55ff','e':'#ffff55','f':'#ffffff'
  }
  let out=''
  let color=null,bold=false,italic=false,under=false,strike=false
  function open(){
    let style=''
    if(color) style+=`color:${color};`
    let dec=[]
    if(under) dec.push('underline')
    if(strike) dec.push('line-through')
    const fs=(bold?'font-weight:700;':'')+(italic?'font-style:italic;':'')+(dec.length?`text-decoration:${dec.join(' ')};`:'')
    return `<span style="${style}${fs}">`
  }
  let i=0
  let openTag=open()
  while(i<s.length){
    const ch=s[i]
    if((ch==='§' || ch==='&') && i+1<s.length){
      const code=s[i+1].toLowerCase()
      if(code==='#'){
        const hex=s.slice(i+2,i+8)
        if(/^[0-9a-fA-F]{6}$/.test(hex)){
          out+=`</span>`
          color='#'+hex
          openTag=open()
          out+=openTag
          i+=8
          continue
        }
      }
      if(map.hasOwnProperty(code)){
        out+=`</span>`
        color=map[code]
        openTag=open()
        out+=openTag
        i+=2
        continue
      }
      if(code==='r'){
        out+=`</span>`
        color=null;bold=false;italic=false;under=false;strike=false
        openTag=open()
        out+=openTag
        i+=2
        continue
      }
      if(code==='l'){ out+=`</span>`; bold=true; out+=openTag; i+=2; continue }
      if(code==='o'){ out+=`</span>`; italic=true; out+=openTag; i+=2; continue }
      if(code==='n'){ out+=`</span>`; under=true; out+=openTag; i+=2; continue }
      if(code==='m'){ out+=`</span>`; strike=true; out+=openTag; i+=2; continue }
      if(code==='k'){ i+=2; continue }
    }
    if(ch==='<'||ch==='>'||ch==='&'){
      const esc={'<':'&lt;','>':'&gt;','&':'&amp;'}
      out+=esc[ch]
    }else{
      out+=ch
    }
    i++
  }
  out+=`</span>`
  return out
}
function markPanelConsoleLines(root){
  if(!root) return
  const lines=root.querySelectorAll('.console-line')
  lines.forEach(el=>{
    if(el.classList.contains('is-panel')) return
    const t=(el.textContent||'').toLowerCase()
    if(t.includes('[panel]')) el.classList.add('is-panel')
  })
}
function setupConsoleColoring(){
  const consoles=document.querySelectorAll('#console, .console')
  consoles.forEach(c=>{
    markPanelConsoleLines(c)
    const mo=new MutationObserver(()=>markPanelConsoleLines(c))
    mo.observe(c,{childList:true,subtree:true,characterData:true})
  })
}
function attachSteppers(){
  document.querySelectorAll('.stepper').forEach(inp=>{
    const wrap=inp.parentElement
    const btns=wrap.querySelector('.stepper-btns')
    if(!btns) return
    btns.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click',()=>{
        const dir=b.dataset.dir
        const step=parseFloat(inp.step||'1')||1
        const min=inp.min!==''?parseFloat(inp.min):-Infinity
        const max=inp.max!==''?parseFloat(inp.max):Infinity
        let v=parseFloat(inp.value||'0')||0
        v=dir==='up'?v+step:v-step
        if(v<min) v=min
        if(v>max) v=max
        inp.value=String(v)
        inp.dispatchEvent(new Event('input',{bubbles:true}))
        inp.dispatchEvent(new Event('change',{bubbles:true}))
      })
    })
  })
}
let sock=null
function ensureSocket(){ if(!sock){ sock=io(); } return sock }
function openRestoreModal(){ const m=document.getElementById('restore-modal'); if(m.parentElement!==document.body){ document.body.appendChild(m) } m.classList.add('show'); resetRestoreSteps(); document.getElementById('restore-close').disabled=true; document.getElementById('restore-sub').textContent='Working…' }
function closeRestoreModal(){ const m=document.getElementById('restore-modal'); m.classList.remove('show') }
function resetRestoreSteps(){ document.querySelectorAll('#restore-modal .step').forEach(s=>{s.classList.remove('active','done','err');s.classList.add('pending')}) }
function setActive(step){
  const s=document.querySelector('#restore-modal .step[data-step="'+step+'"]');
  if(!s) return;
  s.classList.remove('pending','done','err');
  s.classList.add('active');
}
function setDone(step){
  const s=document.querySelector('#restore-modal .step[data-step="'+step+'"]');
  if(!s) return;
  s.classList.remove('pending','active','err');
  s.classList.add('done');
  const d=s.querySelector('.dot-mini');
  if(d){d.classList.remove('err');d.classList.add('ok')}
}
function setErr(step){
  const s=document.querySelector('#restore-modal .step[data-step="'+step+'"]');
  if(!s) return;
  s.classList.remove('pending','active','done');
  s.classList.add('err');
  const d=s.querySelector('.dot-mini');
  if(d){d.classList.remove('ok');d.classList.add('err')}
}
function el(t,a,c){const n=document.createElement(t);if(a){const d=a.dataset;const r={...a};delete r.dataset;Object.assign(n,r);if(d){for(const k in d){n.setAttribute('data-'+k.replace(/[A-Z]/g,m=>'-'+m.toLowerCase()),d[k])}}}if(c!==undefined)n.innerHTML=c;return n}
function toast(t,m,type){const w=document.getElementById('toasts');const d=el('div',{className:'toast '+(type||'')});const c=el('div',{className:'t-content'});c.appendChild(el('div',{className:'t-title'},t));c.appendChild(el('div',{className:'t-msg'},m||''));d.appendChild(c);w.appendChild(d);setTimeout(()=>{d.style.animation='toast-out .16s ease forwards';setTimeout(()=>d.remove(),160)},4200)}
function api(p,opts){const base=location.protocol==='file:'?'http://127.0.0.1:5003':'';return fetch(base+p,opts).then(async r=>{const t=await r.text();let j;try{j=JSON.parse(t)}catch(e){}if(!r.ok)throw new Error((j&&j.error)||t||('HTTP '+r.status));return j||{}})}
function fmtSize(b){if(!b&&b!==0)return '—';const u=['B','KB','MB','GB','TB'];let i=0;let x=Number(b);while(x>=1024&&i<u.length-1){x/=1024;i++}return x.toFixed(x>=10||i===0?0:1)+' '+u[i]}
const ids=['auto_restart','restart_delay_sec','auto_start_on_boot','min_ram_mb','max_ram_mb','jvm_extra','scheduled_restart_enabled','scheduled_restart_time','backup_on_restart','backup_keep']
const elms={}
ids.forEach(id=>elms[id]=document.getElementById(id))
const statusText=document.getElementById('status-text')
const dotRun=document.getElementById('dot-running')
const dotPort=document.getElementById('dot-port')
const procTxt=document.getElementById('proc-txt')
const portTxt=document.getElementById('port-txt')
const uptimeTxt=document.getElementById('uptime-txt')
const dotUptime=document.getElementById('dot-uptime')
const mcVer=document.getElementById('mc-ver')
const javaVer=document.getElementById('java-ver')
const pubIp=document.getElementById('pub-ip')
const locIp=document.getElementById('loc-ip')
const motd=document.getElementById('motd')
const btnSave=document.getElementById('btn-save')
const btnRestart=document.getElementById('btn-restart')
const btnStart=document.getElementById('btn-start')
const btnStop=document.getElementById('btn-stop')
const rows=document.getElementById('backup-rows')
const btnBRefresh=document.getElementById('btn-backup-refresh')
const btnBCreate=document.getElementById('btn-backup-create')
const UPTIME_THRESHOLDS={green:3600,yellow:172800}
;(()=>{dotUptime.classList.add('breathe','ping')})()
const modalClose=document.getElementById('restore-close')
modalClose.addEventListener('click',closeRestoreModal)
ensureSocket().on('restore_progress', payload=>{
  const step=(payload&&payload.step)||''
  if(step==='locking'){ setActive('locking') }
  if(step==='stopping'){ setDone('locking'); setActive('stopping') }
  if(step==='replacing'){ setDone('stopping'); setActive('replacing') }
  if(step==='unlocking'){ setDone('replacing'); setActive('unlocking') }
  if(step==='done'){ setDone('unlocking'); setActive('done'); setDone('done'); document.getElementById('restore-sub').textContent='Completed'; modalClose.disabled=false; toast('Restore complete','Files replaced from backup','ok'); loadBackups(); refreshStatus() }
  if(step==='error'){ setErr('replacing'); document.getElementById('restore-sub').textContent=String(payload.error||'Error'); modalClose.disabled=false; toast('Error','Restore failed','err') }
})
function loadSettings(){
  api('/panel-settings-data').then(s=>{
    Object.keys(elms).forEach(k=>{
      const e=elms[k];const v=s[k];
      if(e.type==='checkbox'){e.checked=!!v}else{if(v!==undefined&&v!==null)e.value=String(v)}
    })
  }).catch(e=>toast('Error',e.message||'Failed to load settings','err'))
}
function saveSettings(){
  const body={}
  Object.keys(elms).forEach(k=>{const e=elms[k];body[k]=e.type==='checkbox'?e.checked:(e.value||'')})
  return api('/panel-settings-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
    .then(()=>toast('Saved','Settings updated','ok')).catch(e=>toast('Error',e.message||'Failed to save','err'))
}
function refreshStatus(){
  api('/server-status').then(s=>{
    const st=s.status||'unknown'
    statusText.textContent=st.charAt(0).toUpperCase()+st.slice(1)
    dotRun.classList.toggle('ok',!!s.alive);dotRun.classList.toggle('bad',!s.alive)
    procTxt.textContent=s.alive?'Running':'Not running'
    dotPort.classList.toggle('ok',!!s.port_open);dotPort.classList.toggle('bad',!s.port_open)
  }).catch(()=>{})
  api('/server-info').then(i=>{
    mcVer.textContent=i.mc_version||'—';javaVer.textContent=i.java_version||'—'
    pubIp.textContent=i.public_ip||'—';locIp.textContent=i.local_ip||'—'
    motd.innerHTML=motdToHtml(i.motd||'—')
    uptimeTxt.textContent=i.uptime_human||'—'
    portTxt.textContent=i.port?String(i.port):'—'
    updateUptimeDot(i)
  }).catch(()=>{})
}
function confirmModal(message){
  const modal=document.getElementById('confirm-modal')
  const msg=document.getElementById('confirm-msg')
  const btnYes=document.getElementById('confirm-yes')
  const btnCancel=document.getElementById('confirm-cancel')
  if(modal.parentElement!==document.body){ document.body.appendChild(modal) }
  msg.textContent=message||'Are you sure?'
  modal.classList.add('show')
  return new Promise(resolve=>{
    function cleanup(){
      modal.classList.remove('show')
      btnYes.removeEventListener('click',onYes)
      btnCancel.removeEventListener('click',onCancel)
      modal.removeEventListener('click',onBackdrop)
      document.removeEventListener('keydown',onKey)
    }
    function onYes(){ cleanup(); resolve(true) }
    function onCancel(){ cleanup(); resolve(false) }
    function onBackdrop(e){ if(e.target===modal){ cleanup(); resolve(false) } }
    function onKey(e){ if(e.key==='Escape'){ cleanup(); resolve(false) } }
    btnYes.addEventListener('click',onYes)
    btnCancel.addEventListener('click',onCancel)
    modal.addEventListener('click',onBackdrop)
    document.addEventListener('keydown',onKey)
  })
}

function renderBackups(list){
  rows.innerHTML=''
  if(!Array.isArray(list)||!list.length){
    rows.appendChild(el('div',{className:'small',style:'opacity:.8;padding:6px 2px'},'No backups found'))
    return
  }
  const sorted=[...list].sort((a,b)=>{
    const ta=(a.mtime_ts!==undefined?a.mtime_ts:Date.parse(a.mtime||''))||0
    const tb=(b.mtime_ts!==undefined?b.mtime_ts:Date.parse(b.mtime||''))||0
    return tb-ta
  })
  sorted.forEach(b=>{
    const r=el('div',{className:'tr'})
    r.appendChild(el('div',{className:'name'},'<span class="material-icons mi">folder_zip</span>'+ (b.name+(b.mtime?' • '+b.mtime:''))))
    r.appendChild(el('div',null,fmtSize(b.size_bytes)))
    const acts=el('div',{className:'actions'})

    const btnDl=el('button',{className:'btn sm icon flat',title:'Download'},'<span class="material-icons mi">download</span>')
    btnDl.addEventListener('click',()=>{
      const a=document.createElement('a');a.href='/backup-download?name='+encodeURIComponent(b.name);a.download=b.name;document.body.appendChild(a);a.click();a.remove()
    })

    const btnRestore=el('button',{className:'btn sm icon success',title:'Restore'},'<span class="material-icons mi">settings_backup_restore</span>')
    btnRestore.addEventListener('click',()=>{
      confirmModal('Restore "'+b.name+'"? This will stop the server and replace files.')
        .then(ok=>{
          if(!ok) return
          openRestoreModal()
          setActive('locking')
          btnRestore.disabled=true
          return fetch('/backup-restore',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:b.name})})
            .then(r=>r.ok?r.json():Promise.reject())
            .then(j=>{ if(!(j&&j.ok)) throw new Error('Restore failed') })
            .catch(()=>{ toast('Error','Restore failed to start','err'); btnRestore.disabled=false })
        })
    })

    const btnDel=el('button',{className:'btn sm icon danger',title:'Delete'},'<span class="material-icons mi">delete</span>')
    btnDel.addEventListener('click',()=>{
      if(!confirm('Delete "'+b.name+'"?')) return
      btnDel.disabled=true
      fetch('/backup-delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:b.name})})
        .then(r=>r.ok?r.json():Promise.reject())
        .then(j=>{ if(j&&j.ok){ toast('Deleted',b.name,'ok'); loadBackups(); } else { throw new Error('Delete failed') } })
        .catch(()=>toast('Error','Delete failed','err'))
        .finally(()=>{btnDel.disabled=false})
    })

    acts.appendChild(btnDl)
    acts.appendChild(btnRestore)
    acts.appendChild(btnDel)
    r.appendChild(acts)
    rows.appendChild(r)
  })
}

function parseUptimeToSeconds(v){
  if(v==null) return null
  if(typeof v==='number') return v
  if(/^\d+$/.test(String(v))) return parseInt(v,10)
  const s=String(v).toLowerCase()
  let total=0
  const d=s.match(/(\d+)\s*d/); if(d) total+=parseInt(d[1],10)*86400
  const h=s.match(/(\d+)\s*h/); if(h) total+=parseInt(h[1],10)*3600
  const m=s.match(/(\d+)\s*m/); if(m) total+=parseInt(m[1],10)*60
  const sec=s.match(/(\d+)\s*s/); if(sec) total+=parseInt(sec[1],10)
  return total||null
}
function colorForUptime(secs){
  if(secs==null) return '#9aa0ab'
  if(secs<UPTIME_THRESHOLDS.green) return '#22c55e'
  if(secs<UPTIME_THRESHOLDS.yellow) return '#eab308'
  return '#ef4444'
}
function updateUptimeDot(i){
  const secs=i.uptime_seconds??i.uptime_sec??i.uptime??parseUptimeToSeconds(i.uptime_human)
  const c=colorForUptime(secs)
  dotUptime.style.setProperty('--dot-color',c)
}

function loadBackups(){api('/backups-list').then(j=>renderBackups(j.items||[])).catch(e=>toast('Error',e.message||'Failed to load backups','err'))}
function withLoading(btn, text, fn){
  const prev = btn.innerHTML
  btn.classList.add('loading'); btn.disabled=true
  btn.innerHTML = '<span class="spin"></span><span class="txt">'+(text||'Working…')+'</span>'
  const done = ()=>{btn.disabled=false;btn.classList.remove('loading');btn.innerHTML=prev}
  return Promise.resolve().then(fn).finally(done)
}
function createBackup(){
  withLoading(btnBCreate,'Creating…',()=>fetch('/backup-create',{method:'POST'}).then(r=>r.json()).then(j=>{
    if(j.ok){toast('Backup created',j.name||'','ok');loadBackups()}
    else{toast('Error','Backup failed','err')}
  }).catch(()=>toast('Error','Backup failed','err')))
}
btnSave.addEventListener('click',saveSettings)
btnRestart.addEventListener('click',()=>{
  withLoading(btnRestart,'Restarting…',()=>fetch('/restart',{method:'POST'})
    .then(r=>r.ok?r.json():Promise.reject())
    .then(()=>toast('Restart','Server restarting','ok'))
    .catch(()=>toast('Error','Restart failed','err')))
})
btnStart.addEventListener('click',()=>{fetch('/start').then(()=>toast('Start','Server starting','ok')).catch(()=>toast('Error','Start failed','err'))})
btnStop.addEventListener('click',()=>{fetch('/stop').then(()=>toast('Stop','Server stopping','ok')).catch(()=>toast('Error','Stop failed','err'))})
btnBRefresh.addEventListener('click',loadBackups)
btnBCreate.addEventListener('click',createBackup)
document.addEventListener('DOMContentLoaded',()=>{setupConsoleColoring();attachSteppers();loadSettings();refreshStatus();loadBackups();setInterval(refreshStatus,4000)})
</script>
{% endblock %}