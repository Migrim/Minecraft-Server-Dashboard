<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Install Server JAR</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--card:#0f0f10;--muted:#a1a1aa;--text:#fff;--accent:#4f46e5;--accent-2:#22c55e;--red:#ef4444;--border:#1f1f22}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 500px at 50% -20%,#1b1b1f,transparent),linear-gradient(#0a0a0a,#0a0a0a);color:var(--text);font-family:Roboto,system-ui,Segoe UI,Arial,sans-serif;display:flex;align-items:center;justify-content:center;padding:24px}
p{margin:0 0 8px;line-height:1.5;color:var(--muted);overflow-wrap:anywhere;word-break:break-word;hyphens:auto}
.card{width:min(760px,94vw);background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 22px 60px rgba(0,0,0,.45);overflow:hidden}
.header{padding:26px 28px 14px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.header h1{margin:0;font-size:22px;letter-spacing:.2px}
.meta{display:grid;grid-template-columns:minmax(140px,1fr) minmax(280px,2fr);gap:10px;padding:0 28px 18px}
.meta .chip{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;font-size:13px;color:#d1d5db;background:#0c0c10;min-width:0}
.meta .chip b{color:#fff;font-weight:600;white-space:nowrap}
.meta .chip span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;position:relative;}
.meta .chip span::after{
  content:attr(title);
  position:absolute;
  bottom:calc(100% + 4px);
  left:0;
  background:#111114;
  color:#fff;
  padding:4px 8px;
  border-radius:6px;
  font-size:12px;
  opacity:0;
  white-space:nowrap;
  pointer-events:none;
  transition:opacity .12s ease;
}
.meta .chip span:hover::after{opacity:1}
@media (max-width:640px){.meta{grid-template-columns:1fr}}
.drop{margin:0 28px 22px;border:1.5px dashed #34343d;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));min-height:220px;display:grid;place-items:center;transition:transform .18s ease,border-color .18s ease,background .18s ease}
.drop.drag{border-color:var(--accent);background:linear-gradient(180deg,rgba(79,70,229,.08),rgba(255,255,255,0));transform:scale(1.01)}
.drop-inner{text-align:center;padding:28px 24px;max-width:520px}
.icon{width:54px;height:54px;margin:0 auto 12px;opacity:.9}
.drop h2{margin:0 0 6px;font-size:18px}
.hint{font-size:13px}
.actions{margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--border);background:#151518;color:#fff;border-radius:10px;padding:10px 14px;font-weight:500;font-size:14px;cursor:pointer;transition:transform .06s ease}
.btn:disabled{opacity:.5;cursor:not-allowed;filter:grayscale(0.6)}
.btn.primary{border-color:#3b3be0;background:linear-gradient(180deg,#5454ff,#3d3de6)}
.btn:active{transform:scale(.98)}
.btn.ghost{background:transparent}
.fileline{margin-top:10px;font-size:13px;color:#cbd5e1;display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;background:#0b0b0d;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
.badge b{color:#fff}
.hidden{display:none}

.progress{height:10px;width:100%;background:#131318;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:14px}
.progress>span{display:block;height:100%;width:0%;background:var(--accent);transition:width .18s ease;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}

.note{padding:0 28px 0 28px;color:#cbd5e1;font-size:13px}
.footer{padding:18px 28px 24px;display:flex;gap:10px;justify-content:flex-end}
.toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:50}
.toast{min-width:280px;max-width:96vw;background:#111114;border:1px solid var(--border);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:12px;box-shadow:0 14px 40px rgba(0,0,0,.45);transform:translateY(16px);opacity:0;animation:toast-in .18s ease forwards}
.toast.ok{border-color:#1f3f28}
.toast.err{border-color:#3a1f22}
.toast .t-content{flex:1}
.toast .t-title{font-weight:600;margin:0 0 2px}
.toast .t-msg{font-size:13px;color:#cbd5e1}
.toast .t-actions{display:flex;gap:8px;margin-left:8px}
.toast .t-btn{border:1px solid var(--border);background:#151518;color:#fff;border-radius:8px;padding:8px 10px;font-size:12px;cursor:pointer}
@keyframes toast-in{to{transform:translateY(0);opacity:1}}
@keyframes toast-out{to{transform:translateY(16px);opacity:0}}
@keyframes spin{to{transform:rotate(360deg)}}
.btn.loading{position:relative;color:transparent}
.btn.loading:after{content:"";position:absolute;inset:0;margin:auto;width:16px;height:16px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;animation:spin .6s linear infinite}
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <h1>Upload Minecraft Server Jar File</h1>
    <button class="btn ghost" id="checkBtn">Check Status</button>
  </div>

  <div class="meta">
    <div class="chip"><b>Expected:</b> <span>{{ expected }}</span></div>
    <div class="chip"><b>Target:</b> <span title="{{ server_dir }}">{{ server_dir }}</span></div>
  </div>

  <div id="drop" class="drop" tabindex="0" aria-label="Upload area">
    <div class="drop-inner">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 16V4m0 0l-4 4m4-4l4 4M6 12H5a3 3 0 00-3 3v2a3 3 0 003 3h14a3 3 0 003-3v-2a3 3 0 00-3-3h-1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <h2>Drag & Drop your .jar</h2>
      <p class="hint">or choose a file</p>
      <div class="actions">
        <button id="choose" class="btn">Choose File</button>
        <button id="upload" class="btn primary hidden">Upload</button>
      </div>
      <div class="fileline" id="fileline"></div>
      <input id="file" type="file" accept=".jar" class="hidden">
      <div class="progress hidden" id="bar"><span></span></div>
    </div>
  </div>

  <div class="note">After a successful upload you will be redirected to the dashboard.</div>
  <div class="footer"></div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const drop=document.getElementById('drop')
const fileInput=document.getElementById('file')
const chooseBtn=document.getElementById('choose')
const uploadBtn=document.getElementById('upload')
const bar=document.getElementById('bar')
const barFill=bar.querySelector('span')
const fileline=document.getElementById('fileline')
const checkBtn=document.getElementById('checkBtn')
const toasts=document.getElementById('toasts')
let file=null

function enableUpload(b){uploadBtn.classList.toggle('hidden',!b)}
function setFileLine(f){
  if(!f){fileline.innerHTML='';return}
  const sizeKB=f.size/1024
  const sizeText=sizeKB>=1024? (sizeKB/1024).toFixed(1)+' MB' : Math.ceil(sizeKB)+' KB'
  fileline.innerHTML='<span class="badge"><b>File</b>'+f.name+'</span>'+'<span class="badge"><b>Size</b>'+sizeText+'</span>'
}
function toast(title,msg,type,actions,durationMs){
  const t=document.createElement('div')
  t.className='toast '+(type||'')
  t.innerHTML='<div class="t-content"><div class="t-title">'+title+'</div><div class="t-msg">'+(msg||'')+'</div></div>'
  const act=document.createElement('div')
  act.className='t-actions'
  ;(actions||[]).forEach(a=>{const b=document.createElement('button');b.className='t-btn';b.textContent=a.label;b.onclick=()=>{a.onClick&&a.onClick();close()};act.appendChild(b)})
  t.appendChild(act)
  toasts.appendChild(t)
  const tMsg=t.querySelector('.t-msg')
  const dur=typeof durationMs==='number'&&durationMs>0?durationMs:4500
  let interval=null
  if(dur&&dur>0&&tMsg){
    let sec=Math.ceil(dur/1000)
    if(durationMs){ tMsg.textContent=(msg&&msg.length?msg.replace(/\d+\s*seconds?/,sec+' seconds'):'')||('Closing in '+sec+' seconds') }
    interval=setInterval(()=>{sec--; if(sec>=0&&tMsg){ tMsg.textContent=(msg&&msg.length?msg.replace(/\d+\s*seconds?/,sec+' seconds'):'')||('Closing in '+sec+' seconds') }},1000)
  }
  function close(){ t.style.animation='toast-out .16s ease forwards'; if(interval){clearInterval(interval)} setTimeout(()=>t.remove(),160) }
  setTimeout(close,dur)
  return {close,el:t}
}

function clearChooseLoading(){ chooseBtn.classList.remove('loading') }
function setChooseLoading(b){
  if(b){
    chooseBtn.classList.add('loading')
    setTimeout(()=>window.addEventListener('focus',clearChooseLoading,{once:true}),0)
  }else{
    clearChooseLoading()
  }
}

chooseBtn.onclick=()=>{ setChooseLoading(true); fileInput.click() }
fileInput.onchange=e=>{clearChooseLoading();file=e.target.files[0]||null;setFileLine(file);enableUpload(!!file)}

;['dragenter','dragover'].forEach(ev=>{drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag')})})
;['dragleave','drop'].forEach(ev=>{drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag')})})
drop.addEventListener('drop',e=>{
  const dt=e.dataTransfer
  if(!dt||!dt.files||!dt.files.length)return
  const f=dt.files[0]
  if(!f.name.toLowerCase().endsWith('.jar')){toast('Invalid file','Please select a .jar file','err');return}
  file=f;setFileLine(file);enableUpload(true)
})

uploadBtn.onclick=()=>{
  if(!file){toast('No file','Choose a .jar first','err');return}
  if(!file.name.toLowerCase().endsWith('.jar')){toast('Invalid file','Please select a .jar file','err');return}
  const fd=new FormData();fd.append('file',file)
  const xhr=new XMLHttpRequest();xhr.open('POST','/upload-jar')
  xhr.upload.onprogress=e=>{if(e.lengthComputable){const p=Math.round((e.loaded/e.total)*100);bar.classList.remove('hidden');barFill.style.width=p+'%'}}
  xhr.onload=()=>{let ok=false,err='';try{const r=JSON.parse(xhr.responseText);ok=!!r.ok;err=r.error||''}catch(_){err='Unexpected response'}
    if(ok){
      uploadBtn.disabled = true
      chooseBtn.disabled = true
      const t=toast('Upload complete','Redirecting in 7 seconds','ok',[{label:'Open Dashboard',onClick:()=>location.href='/'},{label:'Check Status',onClick:()=>window.open('/jar-status','_blank')}],7000)
      setTimeout(()=>{window.location.href='/'},7000)
    }else{
      toast('Upload failed',err||'Please try again','err',[{label:'Retry',onClick:()=>uploadBtn.click()}])
      uploadBtn.disabled = false
      chooseBtn.disabled = false
    }}
  xhr.onerror=()=>{toast('Network error','Please check your connection','err')}
  xhr.send(fd)
}

checkBtn.onclick=async()=>{
  try{
    const r=await fetch('/jar-status',{headers:{'Accept':'application/json'}})
    if(!r.ok) throw new Error('HTTP '+r.status)
    const j=await r.json()
    const msg=(j.status||'Unknown').toString()
    toast('Server Status',msg,'ok',[{label:'Open',onClick:()=>window.open('/jar-status','_blank')}])
  }catch(e){
    toast('Status Error','Could not fetch status','err',[{label:'Open',onClick:()=>window.open('/jar-status','_blank')}])
  }
}
</script>
</body>
</html>
